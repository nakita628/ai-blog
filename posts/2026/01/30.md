---
date: 2026-01-30
title: Atlas入門 - モダンなデータベーススキーマ管理とマイグレーション
description: Atlasは宣言的スキーマ管理とバージョン管理マイグレーションを統合したデータベースマイグレーションツールである。主要DBに対応し、CI/CD統合やORMサポートも充実している。本記事ではAtlasの基本概念と実践的な使い方を解説する。
tags:
  - database
  - migration
  - devops
  - go
  - postgresql
  - mysql
prev:
  text: 'Effect入門 - TypeScriptで型安全なエラーハンドリングを実現する'
  link: '/posts/2026/01/29'
next:
  text: 'Tailwind CSSで実装するレスポンシブレイアウト - ヘッダーとサイドバーの実践ガイド'
  link: '/posts/2026/01/31'
---

# Atlas入門 - モダンなデータベーススキーマ管理とマイグレーション

データベースマイグレーションは多くの開発チームにとって悩みの種である。手動でマイグレーションスクリプトを書くのは手間がかかり、本番環境での適用時にヒヤヒヤすることも多い。

[Atlas](https://atlasgo.io/)は、Ariga社が開発したモダンなデータベーススキーマ管理ツールである。Terraformのような「宣言的アプローチ」をデータベース管理に持ち込み、スキーマの差分検出からマイグレーション計画の自動生成まで、一貫したワークフローを提供する。

## Atlasの特徴

Atlasが従来のマイグレーションツールと異なる点を整理する。

```mermaid
flowchart TB
    subgraph Traditional["従来のマイグレーションツール"]
        T1["手動でマイグレーション<br/>スクリプトを作成"]
        T2["変更内容を<br/>都度記述"]
        T3["差分の把握が困難"]
    end

    subgraph Atlas["Atlas"]
        A1["スキーマを宣言的に定義"]
        A2["差分を自動計算"]
        A3["安全なマイグレーション<br/>を自動生成"]
    end

    T1 -.-> A1
    T2 -.-> A2
    T3 -.-> A3

    style T1 fill:#e74c3c,color:#fff
    style T2 fill:#e74c3c,color:#fff
    style T3 fill:#e74c3c,color:#fff
    style A1 fill:#2ecc71,color:#fff
    style A2 fill:#2ecc71,color:#fff
    style A3 fill:#2ecc71,color:#fff
```

| 特徴                               | 説明                                                     |
| ---------------------------------- | -------------------------------------------------------- |
| **宣言的スキーマ管理**             | 「あるべき姿」を定義すれば、差分をAtlasが自動計算        |
| **バージョン管理マイグレーション** | Gitで管理可能なマイグレーションファイルを生成            |
| **多数のDB対応**                   | PostgreSQL, MySQL, MariaDB, SQLite, SQL Server, Oracle等 |
| **ORM連携**                        | GORM, TypeORM, Sequelize, Prismaなど主要ORMに対応        |
| **CI/CD統合**                      | GitHub Actions, GitLab CI等との統合が容易                |
| **スキーマリント**                 | 危険な変更や非推奨パターンを検出                         |

## インストール

Atlasは複数の方法でインストールできる。

```bash
# macOS / Linux（推奨）
curl -sSf https://atlasgo.sh | sh

# Homebrew
brew install ariga/tap/atlas

# Docker
docker pull arigaio/atlas
```

インストール後、バージョンを確認する。

```bash
atlas version
```

## 2つのワークフロー

Atlasには「宣言的ワークフロー」と「バージョン管理ワークフロー」の2つの使い方がある。

```mermaid
flowchart LR
    subgraph Declarative["宣言的ワークフロー"]
        D1["スキーマ定義"] --> D2["atlas schema apply"]
        D2 --> D3["DBに直接適用"]
    end

    subgraph Versioned["バージョン管理ワークフロー"]
        V1["スキーマ定義"] --> V2["atlas migrate diff"]
        V2 --> V3["マイグレーション<br/>ファイル生成"]
        V3 --> V4["レビュー・Git管理"]
        V4 --> V5["atlas migrate apply"]
    end

    style D1 fill:#4a90d9,color:#fff
    style D3 fill:#2ecc71,color:#fff
    style V1 fill:#4a90d9,color:#fff
    style V5 fill:#2ecc71,color:#fff
```

### 宣言的ワークフロー

開発環境やプロトタイピングに適している。スキーマファイルを定義し、`atlas schema apply`で直接DBに適用する。

### バージョン管理ワークフロー

本番環境での運用に適している。マイグレーションファイルをGitで管理し、レビューを経てからデプロイする。従来のマイグレーションツールに近いが、差分計算が自動化される点が異なる。

## 基本的な使い方

### 1. 既存スキーマの検査

まず、既存のデータベーススキーマをHCL形式で出力してみる。

```bash
# PostgreSQLの例
atlas schema inspect \
  -u "postgres://user:pass@localhost:5432/mydb?sslmode=disable" \
  --format '{{ sql . }}'

# MySQLの例
atlas schema inspect \
  -u "mysql://root:pass@localhost:3306/mydb"
```

出力例（HCL形式）：

```hcl
table "users" {
  schema = schema.public
  column "id" {
    type = int
  }
  column "name" {
    type = varchar(255)
  }
  column "email" {
    type = varchar(255)
  }
  primary_key {
    columns = [column.id]
  }
  index "idx_users_email" {
    columns = [column.email]
    unique  = true
  }
}
```

### 2. スキーマの定義

`schema.hcl`ファイルを作成し、望ましいスキーマを定義する。

```hcl
// schema.hcl
table "users" {
  schema = schema.public
  column "id" {
    type = serial
  }
  column "name" {
    type = varchar(255)
    null = false
  }
  column "email" {
    type = varchar(255)
    null = false
  }
  column "created_at" {
    type    = timestamptz
    default = sql("now()")
  }
  primary_key {
    columns = [column.id]
  }
  index "idx_users_email" {
    columns = [column.email]
    unique  = true
  }
}

table "posts" {
  schema = schema.public
  column "id" {
    type = serial
  }
  column "user_id" {
    type = int
    null = false
  }
  column "title" {
    type = varchar(255)
    null = false
  }
  column "body" {
    type = text
  }
  column "created_at" {
    type    = timestamptz
    default = sql("now()")
  }
  primary_key {
    columns = [column.id]
  }
  foreign_key "fk_posts_user" {
    columns     = [column.user_id]
    ref_columns = [table.users.column.id]
    on_delete   = CASCADE
  }
}

schema "public" {}
```

### 3. 宣言的マイグレーションの適用

定義したスキーマをデータベースに適用する。

```bash
atlas schema apply \
  -u "postgres://user:pass@localhost:5432/mydb?sslmode=disable" \
  --to file://schema.hcl
```

Atlasは現在のDB状態と定義ファイルの差分を計算し、必要なSQLを生成・表示する。確認後、適用を承認すると変更が反映される。

```
-- Planned Changes:
-- Create "posts" table
CREATE TABLE "public"."posts" (
  "id" serial NOT NULL,
  "user_id" integer NOT NULL,
  "title" character varying(255) NOT NULL,
  "body" text NULL,
  "created_at" timestamptz NOT NULL DEFAULT now(),
  PRIMARY KEY ("id"),
  CONSTRAINT "fk_posts_user" FOREIGN KEY ("user_id")
    REFERENCES "public"."users" ("id") ON DELETE CASCADE
);
? Are you sure?:
```

## バージョン管理マイグレーション

本番環境では、マイグレーションファイルをGitで管理する方式が推奨される。

```mermaid
sequenceDiagram
    participant Dev as 開発者
    participant Atlas as Atlas CLI
    participant Git as Git
    participant CI as CI/CD
    participant Prod as 本番DB

    Dev->>Atlas: atlas migrate diff
    Atlas->>Atlas: 差分を計算
    Atlas->>Dev: マイグレーションファイル生成
    Dev->>Git: コミット・プッシュ
    Git->>CI: PR作成・レビュー
    CI->>Atlas: atlas migrate lint
    CI->>Prod: atlas migrate apply
```

### マイグレーションファイルの生成

```bash
# migrationsディレクトリにマイグレーションファイルを生成
atlas migrate diff add_posts_table \
  --dir "file://migrations" \
  --to "file://schema.hcl" \
  --dev-url "docker://postgres/15/dev?search_path=public"
```

`--dev-url`は差分計算用の一時的なデータベースを指定する。Dockerを使えば自動でコンテナが起動・破棄される。

生成されるファイル：

```
migrations/
├── 20260130120000_add_posts_table.sql
└── atlas.sum
```

`atlas.sum`はマイグレーションファイルの整合性チェック用ハッシュである。改ざん検知に使われる。

### マイグレーションの適用

```bash
atlas migrate apply \
  -u "postgres://user:pass@localhost:5432/mydb?sslmode=disable" \
  --dir "file://migrations"
```

## プロジェクト設定ファイル

`atlas.hcl`にプロジェクト設定をまとめることで、コマンドを簡潔にできる。

```hcl
// atlas.hcl
env "local" {
  src = "file://schema.hcl"
  url = "postgres://user:pass@localhost:5432/mydb?sslmode=disable"
  dev = "docker://postgres/15/dev?search_path=public"
  migration {
    dir = "file://migrations"
  }
}

env "production" {
  src = "file://schema.hcl"
  url = getenv("DATABASE_URL")
  migration {
    dir = "file://migrations"
  }
}
```

設定ファイルがあれば、環境名を指定するだけでコマンドを実行できる。

```bash
# ローカル環境でマイグレーション生成
atlas migrate diff add_feature --env local

# 本番環境にマイグレーション適用
atlas migrate apply --env production
```

## ORM連携

AtlasはGORM、TypeORM、Sequelize、Prismaなど主要なORMと連携できる。ORMのモデル定義から直接スキーマを読み取り、マイグレーションを生成する。

### GORMとの連携例

```go
// models/user.go
package models

import "gorm.io/gorm"

type User struct {
	gorm.Model
	Name  string `gorm:"size:255;not null"`
	Email string `gorm:"size:255;not null;uniqueIndex"`
}

type Post struct {
	gorm.Model
	UserID uint   `gorm:"not null"`
	Title  string `gorm:"size:255;not null"`
	Body   string `gorm:"type:text"`
	User   User   `gorm:"foreignKey:UserID;constraint:OnDelete:CASCADE"`
}
```

```bash
# GORMモデルからマイグレーション生成
atlas migrate diff add_models \
  --dir "file://migrations" \
  --to "gorm://./models" \
  --dev-url "docker://postgres/15/dev"
```

## CI/CD統合

### GitHub Actionsでの利用

```yaml
# .github/workflows/atlas.yml
name: Atlas CI
on:
  pull_request:
    paths:
      - 'migrations/**'
      - 'schema.hcl'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ariga/setup-atlas@v0
      - name: Lint migrations
        run: |
          atlas migrate lint \
            --dir "file://migrations" \
            --dev-url "docker://postgres/15/dev" \
            --latest 1
```

`atlas migrate lint`は、破壊的変更や非推奨パターンを検出してくれる。PRレビュー時の安全網として有効である。

## スキーマリント

Atlasはマイグレーションの品質をチェックするリント機能を備えている。

```bash
atlas migrate lint \
  --dir "file://migrations" \
  --dev-url "docker://postgres/15/dev" \
  --latest 1
```

検出される問題の例：

- `NOT NULL`カラムのデフォルト値なし追加（データ損失リスク）
- インデックスなしの外部キー（パフォーマンス問題）
- テーブル・カラムの削除（破壊的変更）

## まとめ

Atlasは「宣言的なスキーマ定義」と「自動的な差分計算」によって、データベースマイグレーションの負担を大幅に軽減するツールである。

主なメリットは以下の通り。

- **差分計算の自動化**: 手動でマイグレーションスクリプトを書く必要がない
- **柔軟なワークフロー**: 宣言的/バージョン管理の両方に対応
- **広範なDB対応**: PostgreSQL, MySQL, SQLiteから、Snowflake, ClickHouseまで
- **ORM連携**: 既存プロジェクトへの導入が容易
- **CI/CD統合**: 自動リントとデプロイパイプラインの構築が簡単

Terraformでインフラを管理しているチームなら、同様の思想でデータベーススキーマも管理できる点が魅力的である。新規プロジェクトはもちろん、既存プロジェクトのマイグレーション改善にも検討する価値がある。

## 参考

- [Atlas - 公式サイト](https://atlasgo.io/)
- [Atlas Documentation - Getting Started](https://atlasgo.io/getting-started)
- [Atlas GitHub Repository](https://github.com/ariga/atlas)
- [GORM Integration Guide](https://atlasgo.io/guides/orms/gorm)
- [Atlas CI/CD - GitHub Actions](https://atlasgo.io/guides/ci-platforms/github-actions)
