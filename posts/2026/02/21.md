---
date: 2026-02-21
title: Cloudflare × GitHub Actions × dotenvx 実践ガイド ― 大量の環境変数を安全に管理・デプロイする
description: Cloudflare Workers へのデプロイを GitHub Actions で自動化しつつ、dotenvx による暗号化で大量の環境変数を安全に管理する方法を解説する。暗号化の仕組み、マルチ環境対応、CI/CD パイプラインへの統合まで実践的に紹介する。
tags:
  - cloudflare
  - github-actions
  - dotenvx
  - devops
  - typescript
prev:
  text: 'OpenClaw 実践ガイド ― ローカルファーストなパーソナルAIアシスタントの導入と活用'
  link: '/posts/2026/02/20'
next:
  text: 'Terraform 入門ガイド ― インフラをコードで管理する第一歩'
  link: '/posts/2026/02/22'
---

# Cloudflare × GitHub Actions × dotenvx 実践ガイド ― 大量の環境変数を安全に管理・デプロイする

環境変数の管理はプロジェクトが成長するにつれて複雑化する。API キー、データベース接続文字列、外部サービスのトークンなど、数十個の秘密情報を複数環境（開発・ステージング・本番・CI）で安全に扱うのは容易ではない。dotenvx は `.env` ファイルを公開鍵暗号で暗号化し、Git に安全にコミットできる次世代の環境変数管理ツールである。本記事では Cloudflare Workers へのデプロイを GitHub Actions で自動化しながら、dotenvx で大量の環境変数を管理する方法を解説する。

## 全体アーキテクチャ

```mermaid
flowchart TD
    A[開発者] -->|dotenvx encrypt| B[暗号化された .env]
    B -->|git push| C[GitHub リポジトリ]
    C -->|GitHub Actions| D[CI/CD パイプライン]
    D -->|DOTENV_PRIVATE_KEY で復号| E[dotenvx run]
    E -->|wrangler deploy| F[Cloudflare Workers]

    G[.env.keys] -.->|秘密鍵は Git に含めない| H[GitHub Secrets]
    H -->|env 経由で注入| D

    style A fill:#4a90d9,color:#fff
    style B fill:#e74c3c,color:#fff
    style F fill:#f39c12,color:#fff
    style G fill:#e74c3c,color:#fff
    style H fill:#9b59b6,color:#fff
```

## dotenvx とは

dotenvx は、`dotenv` の作者 Scott Motte が開発した次世代の環境変数管理ツールである。ECIES（楕円曲線統合暗号）と AES-256 を使い、`.env` ファイルの値を個別に暗号化する。暗号化された `.env` を Git にコミットし、秘密鍵だけを安全に管理すればよい。

### 主な特徴

- **言語・フレームワーク非依存**: Node.js、Python、Go、Rust など何でも使える
- **マルチ環境対応**: `.env.development`、`.env.production`、`.env.ci` を使い分け
- **個別暗号化**: 各変数が独立した暗号鍵で暗号化される
- **変数展開**: `${VAR}`、`${VAR:-default}` 構文をサポート
- **大量の変数に対応**: 変数ごとに独立した一時鍵で暗号化するため、数に上限がない

### インストール

```bash
# npm
npm install @dotenvx/dotenvx --save

# bun
bun add @dotenvx/dotenvx

# curl（グローバル）
curl -sfS https://dotenvx.sh | sh

# Homebrew
brew install dotenvx/brew/dotenvx
```

## dotenvx の基本操作

### 暗号化ワークフロー

```mermaid
sequenceDiagram
    participant Dev as 開発者
    participant Env as .env
    participant Keys as .env.keys
    participant Git as Git リポジトリ

    Dev->>Env: 平文で値を記述
    Dev->>Dev: dotenvx encrypt
    Dev-->>Env: 値が暗号化される
    Dev-->>Keys: 秘密鍵が生成される
    Dev->>Git: .env をコミット（安全）
    Note over Keys,Git: .env.keys は .gitignore に追加
```

### 環境変数の作成と暗号化

```bash
# .env ファイルを作成
cat << 'EOF' > .env
DATABASE_URL="postgresql://user:pass@localhost:5432/mydb"
REDIS_URL="redis://localhost:6379"
API_KEY="sk-xxxxxxxxxxxxxxxxxxxx"
JWT_SECRET="my-super-secret-jwt-key"
STRIPE_SECRET_KEY="sk_live_xxxxxxxxxxxx"
SENDGRID_API_KEY="SG.xxxxxxxxxxxx"
SENTRY_DSN="https://xxxx@sentry.io/1234"
AWS_ACCESS_KEY_ID="AKIAIOSFODNN7EXAMPLE"
AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
CLOUDFLARE_ACCOUNT_ID="abc123def456"
EOF

# 暗号化
dotenvx encrypt
```

暗号化後の `.env` は以下のようになる。

```ini
#/-------------------[DOTENV_PUBLIC_KEY]--------------------/
#/            public-key encryption for .env files          /
#/       [how it works](https://dotenvx.com/encryption)     /
#/----------------------------------------------------------/
DOTENV_PUBLIC_KEY="034af..."
DATABASE_URL="encrypted:BG3oa..."
REDIS_URL="encrypted:BHx1k..."
API_KEY="encrypted:BGn2p..."
# ... 以降も同様に暗号化
```

### マルチ環境の管理

大量の環境変数を持つプロジェクトでは、環境ごとにファイルを分割する。

```bash
# 開発用
dotenvx set DATABASE_URL "postgresql://localhost:5432/dev" -f .env.development
dotenvx set REDIS_URL "redis://localhost:6379" -f .env.development

# 本番用
dotenvx set DATABASE_URL "postgresql://prod-host:5432/prod" -f .env.production
dotenvx set REDIS_URL "redis://prod-redis:6379" -f .env.production

# CI 用
dotenvx set DATABASE_URL "postgresql://test-host:5432/test" -f .env.ci
dotenvx set API_KEY "sk-test-key" -f .env.ci

# 各環境を暗号化
dotenvx encrypt -f .env.development
dotenvx encrypt -f .env.production
dotenvx encrypt -f .env.ci
```

実行時に環境を指定する。

```bash
# 開発環境で起動
dotenvx run -f .env.development -- bun run dev

# 本番環境で起動
dotenvx run -f .env.production -- bun run start

# CI 環境でテスト
dotenvx run -f .env.ci -- bun test
```

## Cloudflare Workers との統合

### プロジェクトセットアップ

```bash
# プロジェクト作成
bun create cloudflare my-worker
cd my-worker

# dotenvx を追加
bun add @dotenvx/dotenvx
```

### Worker での環境変数読み込み

```typescript
// src/index.ts
import '@dotenvx/dotenvx/config'

export default {
  async fetch(request: Request): Promise<Response> {
    const dbUrl = process.env.DATABASE_URL
    const apiKey = process.env.API_KEY

    return new Response(
      JSON.stringify({
        status: 'ok',
        hasDb: !!dbUrl,
        hasApiKey: !!apiKey,
      }),
      {
        headers: { 'Content-Type': 'application/json' },
      },
    )
  },
}
```

### wrangler.toml の設定

```toml
name = "my-worker"
main = "src/index.ts"
compatibility_date = "2024-12-01"

# 非機密の変数は vars に定義
[vars]
APP_ENV = "production"
LOG_LEVEL = "info"

# 機密情報は dotenvx で管理し、wrangler secret 経由で設定
# wrangler secret put DOTENV_PRIVATE_KEY
```

### ローカル開発時の注意

Wrangler の `dev` モードは `.dev.vars` から環境変数を読む。dotenvx の `decrypt` コマンドで対応できる。

```bash
# 暗号化された .env を復号して .dev.vars に出力
dotenvx decrypt --stdout > .dev.vars

# 開発サーバーを起動
wrangler dev
```

## GitHub Actions でのデプロイ自動化

### ワークフロー全体像

```mermaid
flowchart LR
    A[git push] --> B[checkout]
    B --> C[setup Node/Bun]
    C --> D[install dotenvx]
    D --> E[dotenvx run]
    E --> F[wrangler deploy]

    style A fill:#4a90d9,color:#fff
    style F fill:#f39c12,color:#fff
```

### 基本ワークフロー

```yaml
# .github/workflows/deploy.yml
name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install dotenvx
        run: curl -sfS https://dotenvx.sh/install.sh | sh

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
        env:
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
```

### 大量の環境変数を扱うワークフロー

環境変数が多い場合、GitHub Secrets に一つ一つ登録するのは非現実的である。dotenvx ならば秘密鍵 1 つだけを Secrets に登録すれば、暗号化された `.env` ファイル内のすべての変数が復号される。

```yaml
# .github/workflows/deploy-multi-env.yml
name: Deploy Multi-Environment

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Install dotenvx
        run: curl -sfS https://dotenvx.sh/install.sh | sh

      # 環境の決定
      - name: Set environment
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "name=production" >> "$GITHUB_OUTPUT"
          else
            echo "name=staging" >> "$GITHUB_OUTPUT"
          fi

      # dotenvx で復号 → Wrangler secrets として一括設定
      - name: Set Cloudflare secrets from dotenvx
        run: |
          dotenvx run -f .env.${{ steps.env.outputs.name }} -- printenv \
            | grep -E '^(DATABASE_URL|REDIS_URL|API_KEY|JWT_SECRET|STRIPE_SECRET_KEY)=' \
            | while IFS='=' read -r key value; do
                echo "$value" | wrangler secret put "$key" --env ${{ steps.env.outputs.name }}
              done
        env:
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
          DOTENV_PRIVATE_KEY_STAGING: ${{ secrets.DOTENV_PRIVATE_KEY_STAGING }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # デプロイ
      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env ${{ steps.env.outputs.name }}
```

### GitHub Secrets の登録

```bash
# dotenvx 暗号化で生成された秘密鍵を GitHub Secrets に登録
# .env.keys から該当の秘密鍵を取得
gh secret set DOTENV_PRIVATE_KEY_PRODUCTION --body "$(grep DOTENV_PRIVATE_KEY_PRODUCTION .env.keys | cut -d'=' -f2 | tr -d '"')"
gh secret set DOTENV_PRIVATE_KEY_STAGING --body "$(grep DOTENV_PRIVATE_KEY_STAGING .env.keys | cut -d'=' -f2 | tr -d '"')"

# Cloudflare の認証情報
gh secret set CLOUDFLARE_API_TOKEN --body "your-api-token"
gh secret set CLOUDFLARE_ACCOUNT_ID --body "your-account-id"
```

## 大量の環境変数を管理する実践パターン

### 変数のカテゴリ分割

環境変数が数十個を超える場合、カテゴリごとにファイルを分割する方法もある。

```bash
# データベース関連
.env.database          # DB_HOST, DB_PORT, DB_USER, DB_PASS, ...
# 外部サービス
.env.services          # STRIPE_KEY, SENDGRID_KEY, SENTRY_DSN, ...
# インフラ
.env.infra             # AWS_ACCESS_KEY, CLOUDFLARE_TOKEN, ...
```

dotenvx は複数ファイルの同時読み込みに対応している。

```bash
dotenvx run \
  -f .env.database \
  -f .env.services \
  -f .env.infra \
  -- bun run start
```

### 環境 × カテゴリのマトリクス

```mermaid
stateDiagram-v2
    state "環境変数の構造" as Structure {
        state "development" as dev {
            dev_db: .env.development
        }
        state "staging" as stg {
            stg_db: .env.staging
        }
        state "production" as prod {
            prod_db: .env.production
        }
        state "ci" as ci {
            ci_db: .env.ci
        }
    }

    [*] --> Structure: dotenvx encrypt で一括暗号化
    Structure --> [*]: dotenvx run -f で環境指定
```

### .gitignore の設定

```gitignore
# 秘密鍵は絶対にコミットしない
.env.keys

# 復号されたローカル開発用ファイル
.dev.vars

# 暗号化された .env は OK（コミットする）
# !.env
# !.env.production
# !.env.staging
# !.env.ci
```

## 従来方式との比較

| 観点                   | GitHub Secrets のみ        | dotenvx + GitHub Secrets    |
| ---------------------- | -------------------------- | --------------------------- |
| 変数数の上限           | リポジトリあたり 1000 個   | 制限なし                    |
| 管理場所               | GitHub UI / CLI            | `.env` ファイル（Git 管理） |
| バージョン管理         | 不可（上書き）             | Git の差分で追跡可能        |
| 環境の切り替え         | Environment ごとに手動設定 | ファイル切り替えのみ        |
| ローカル開発との一貫性 | 別途 `.env` を管理         | 同一ファイルを暗号化/復号   |
| 秘密鍵の管理           | 各変数を個別に管理         | 環境あたり 1 つの秘密鍵     |
| チーム共有             | GitHub の権限に依存        | 秘密鍵を安全に共有          |

## まとめ

dotenvx を導入することで、大量の環境変数を暗号化したまま Git 管理でき、Cloudflare Workers へのデプロイも GitHub Actions で自動化できる。従来のように GitHub Secrets に一つ一つ変数を登録する手間がなくなり、環境あたり 1 つの秘密鍵だけを管理すればよい。環境変数のバージョン管理・差分追跡も可能になるため、大規模プロジェクトでの運用に適している。

## 参考

- [dotenvx 公式ドキュメント](https://dotenvx.com/docs/)
- [dotenvx GitHub リポジトリ](https://github.com/dotenvx/dotenvx)
- [dotenvx Cloudflare ガイド](https://dotenvx.com/docs/platforms/cloudflare)
- [dotenvx GitHub Actions ガイド](https://dotenvx.com/docs/cis/github-actions)
- [Cloudflare Workers GitHub Actions デプロイ](https://developers.cloudflare.com/workers/ci-cd/external-cicd/github-actions/)
- [cloudflare/wrangler-action](https://github.com/cloudflare/wrangler-action)
- [Cloudflare Workers 環境変数ドキュメント](https://developers.cloudflare.com/workers/configuration/environment-variables/)
- [Cloudflare Workers Secrets ドキュメント](https://developers.cloudflare.com/workers/configuration/secrets/)
- [Zenn - dotenvxを使って環境変数を暗号化して管理する](https://zenn.dev/cocomina/articles/how-to-use-dotenvx)
- [Qiita - dotenvxで環境変数を安全かつスマートに管理しよう](https://qiita.com/channnnsm/items/2acea2a5ba54b30b28b4)
