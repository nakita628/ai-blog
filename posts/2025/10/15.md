---
date: 2025-10-15
title: uvで作るPython monorepo完全ガイド：ワークスペース管理とプロジェクト構造のベストプラクティス
description: uvのワークスペース機能を使ってPythonのmonorepoを構築する方法を初心者向けに解説。複数のプロジェクトを効率的に管理し、依存関係を共有しながら開発を進めるための実践的な手法を詳しく説明する。
tags:
    - uv
    - python
    - monorepo
    - workspace
    - project-management
    - dependency-management
    - rust
    - astral
prev:
    text: "FastAPIとOpenAPI完全ガイド：型安全なAPI開発と自動ドキュメント生成を初心者向けに解説"
    link: "/posts/2025/10/14"
next: false
---

# uvで作るPython monorepo完全ガイド：ワークスペース管理とプロジェクト構造のベストプラクティス

Pythonプロジェクトが複数に増えてきたとき、それぞれを個別に管理するのは大変です。uvのワークスペース機能を使えば、複数のプロジェクトを一つのリポジトリで効率的に管理できるmonorepoを構築できます。この記事では、uvを使ったmonorepoの構築方法を初心者向けに詳しく解説します。

## monorepoとは

monorepo（モノレポ）は、複数のプロジェクトやパッケージを一つのリポジトリで管理する手法です。以下のようなメリットがあります：

- **依存関係の共有**: 共通のライブラリを複数プロジェクトで使用
- **一括での変更**: 複数プロジェクトにまたがる変更を一度に実行
- **統一された開発環境**: 同じツールチェーンとワークフローを使用
- **コードの再利用**: 共通コンポーネントの効率的な管理

## uvのワークスペース機能

[uv](https://docs.astral.sh/uv/)は、Rustで書かれた高速なPythonパッケージマネージャーです。pip、poetry、pyenvなどの機能を統合し、ワークスペース機能でmonorepoをサポートしています。

### ワークスペースの基本構造

```
my-monorepo/
├── pyproject.toml          # ワークスペース設定
├── packages/
│   ├── shared-lib/         # 共有ライブラリ
│   │   ├── pyproject.toml
│   │   └── src/
│   ├── web-api/            # Web API
│   │   ├── pyproject.toml
│   │   └── src/
│   └── cli-tool/           # CLIツール
│       ├── pyproject.toml
│       └── src/
└── apps/
    ├── frontend/           # フロントエンドアプリ
    │   ├── pyproject.toml
    │   └── src/
    └── backend/            # バックエンドアプリ
        ├── pyproject.toml
        └── src/
```

## ワークスペースの設定

### 1. ルートのpyproject.toml

ワークスペースのルートに`pyproject.toml`を作成します：

```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "my-monorepo"
version = "0.1.0"
description = "My Python monorepo"
dependencies = []

[tool.uv.workspace]
members = [
    "packages/*",
    "apps/*"
]

[tool.uv]
dev-dependencies = [
    "pytest>=7.0.0",
    "black>=23.0.0",
    "ruff>=0.1.0",
    "mypy>=1.0.0"
]
```

### 2. 共有ライブラリの設定

`packages/shared-lib/pyproject.toml`：

```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "shared-lib"
version = "0.1.0"
description = "Shared utilities library"
dependencies = [
    "pydantic>=2.0.0",
    "requests>=2.28.0"
]

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0"
]

[tool.hatch.build.targets.wheel]
packages = ["src/shared_lib"]
```

### 3. Web APIの設定

`packages/web-api/pyproject.toml`：

```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "web-api"
version = "0.1.0"
description = "Web API service"
dependencies = [
    "fastapi>=0.100.0",
    "uvicorn>=0.23.0",
    "shared-lib"  # ワークスペース内のパッケージを参照
]

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "httpx>=0.24.0"
]

[tool.hatch.build.targets.wheel]
packages = ["src/web_api"]
```

## 実践的なmonorepoの構築

### 1. プロジェクトの初期化

```bash
# ワークスペースのルートディレクトリを作成
mkdir my-monorepo
cd my-monorepo

# uvでプロジェクトを初期化
uv init --no-readme

# ワークスペース設定を追加
cat > pyproject.toml << 'EOF'
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "my-monorepo"
version = "0.1.0"
description = "My Python monorepo"
dependencies = []

[tool.uv.workspace]
members = [
    "packages/*",
    "apps/*"
]

[tool.uv]
dev-dependencies = [
    "pytest>=7.0.0",
    "black>=23.0.0",
    "ruff>=0.1.0"
]
EOF
```

### 2. 共有ライブラリの作成

```bash
# 共有ライブラリのディレクトリを作成
mkdir -p packages/shared-lib/src/shared_lib

# 共有ライブラリのpyproject.toml
cat > packages/shared-lib/pyproject.toml << 'EOF'
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "shared-lib"
version = "0.1.0"
description = "Shared utilities library"
dependencies = [
    "pydantic>=2.0.0",
    "requests>=2.28.0"
]

[tool.hatch.build.targets.wheel]
packages = ["src/shared_lib"]
EOF

# 共有ライブラリのコード例
cat > packages/shared-lib/src/shared_lib/__init__.py << 'EOF'
"""Shared utilities library."""

from .models import User, Product
from .utils import validate_email, format_currency

__all__ = ["User", "Product", "validate_email", "format_currency"]
EOF

cat > packages/shared-lib/src/shared_lib/models.py << 'EOF'
"""Data models for shared library."""

from pydantic import BaseModel, EmailStr
from typing import Optional
from decimal import Decimal


class User(BaseModel):
    """User model."""
    id: int
    name: str
    email: EmailStr
    is_active: bool = True


class Product(BaseModel):
    """Product model."""
    id: int
    name: str
    price: Decimal
    description: Optional[str] = None
EOF

cat > packages/shared-lib/src/shared_lib/utils.py << 'EOF'
"""Utility functions."""

import re
from decimal import Decimal
from typing import Union


def validate_email(email: str) -> bool:
    """Validate email format."""
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return bool(re.match(pattern, email))


def format_currency(amount: Union[Decimal, float, int], currency: str = "JPY") -> str:
    """Format amount as currency."""
    if currency == "JPY":
        return f"¥{amount:,.0f}"
    elif currency == "USD":
        return f"${amount:,.2f}"
    else:
        return f"{amount:,.2f} {currency}"
EOF
```

### 3. Web APIの作成

```bash
# Web APIのディレクトリを作成
mkdir -p packages/web-api/src/web_api

# Web APIのpyproject.toml
cat > packages/web-api/pyproject.toml << 'EOF'
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "web-api"
version = "0.1.0"
description = "Web API service"
dependencies = [
    "fastapi>=0.100.0",
    "uvicorn>=0.23.0",
    "shared-lib"  # ワークスペース内のパッケージを参照
]

[tool.hatch.build.targets.wheel]
packages = ["src/web_api"]
EOF

# Web APIのコード例
cat > packages/web-api/src/web_api/__init__.py << 'EOF'
"""Web API package."""

from .main import app

__all__ = ["app"]
EOF

cat > packages/web-api/src/web_api/main.py << 'EOF'
"""FastAPI application."""

from fastapi import FastAPI
from shared_lib.models import User, Product
from shared_lib.utils import validate_email, format_currency
from typing import List

app = FastAPI(title="My Web API", version="0.1.0")

# サンプルデータ
users = [
    User(id=1, name="Alice", email="alice@example.com"),
    User(id=2, name="Bob", email="bob@example.com"),
]

products = [
    Product(id=1, name="Laptop", price=999.99, description="High-performance laptop"),
    Product(id=2, name="Mouse", price=29.99, description="Wireless mouse"),
]


@app.get("/")
async def root():
    """Root endpoint."""
    return {"message": "Hello from Web API!"}


@app.get("/users", response_model=List[User])
async def get_users():
    """Get all users."""
    return users


@app.get("/products", response_model=List[Product])
async def get_products():
    """Get all products."""
    return products


@app.get("/products/{product_id}/price")
async def get_product_price(product_id: int):
    """Get formatted product price."""
    product = next((p for p in products if p.id == product_id), None)
    if not product:
        return {"error": "Product not found"}
    
    return {
        "product_id": product_id,
        "formatted_price": format_currency(product.price, "USD")
    }
EOF
```

### 4. CLIツールの作成

```bash
# CLIツールのディレクトリを作成
mkdir -p packages/cli-tool/src/cli_tool

# CLIツールのpyproject.toml
cat > packages/cli-tool/pyproject.toml << 'EOF'
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "cli-tool"
version = "0.1.0"
description = "CLI tool"
dependencies = [
    "click>=8.0.0",
    "shared-lib"  # ワークスペース内のパッケージを参照
]

[project.scripts]
my-cli = "cli_tool.main:cli"

[tool.hatch.build.targets.wheel]
packages = ["src/cli_tool"]
EOF

# CLIツールのコード例
cat > packages/cli-tool/src/cli_tool/__init__.py << 'EOF'
"""CLI tool package."""

from .main import cli

__all__ = ["cli"]
EOF

cat > packages/cli-tool/src/cli_tool/main.py << 'EOF'
"""CLI tool main module."""

import click
from shared_lib.utils import validate_email, format_currency


@click.group()
def cli():
    """My CLI tool."""
    pass


@cli.command()
@click.argument('email')
def validate(email: str):
    """Validate an email address."""
    if validate_email(email):
        click.echo(f"✅ {email} is valid")
    else:
        click.echo(f"❌ {email} is invalid")


@cli.command()
@click.argument('amount', type=float)
@click.option('--currency', default='JPY', help='Currency code')
def format(amount: float, currency: str):
    """Format amount as currency."""
    formatted = format_currency(amount, currency)
    click.echo(f"Formatted: {formatted}")


if __name__ == '__main__':
    cli()
EOF
```

## ワークスペースの操作

### 依存関係の管理

```bash
# ワークスペース全体の依存関係を同期
uv sync

# 特定のパッケージに依存関係を追加
uv add --package shared-lib pytest

# ワークスペース全体に開発依存関係を追加
uv add --dev pytest-cov

# ロックファイルの生成
uv lock
```

### スクリプトの実行

```bash
# 特定のパッケージでスクリプトを実行
uv run --package web-api uvicorn web_api.main:app --reload

# CLIツールを実行
uv run --package cli-tool my-cli validate alice@example.com
uv run --package cli-tool my-cli format 1000 --currency USD

# ワークスペース全体でテストを実行
uv run pytest
```

### パッケージのビルドと公開

```bash
# 特定のパッケージをビルド
uv build --package shared-lib

# ワークスペース全体をビルド
uv build

# パッケージを公開（PyPIなど）
uv publish --package shared-lib
```

## 開発ワークフローのベストプラクティス

### 1. 依存関係の管理

```bash
# ワークスペース全体の依存関係を確認
uv tree

# 依存関係の競合を解決
uv lock --upgrade

# 不要な依存関係を削除
uv remove --package web-api unused-package
```

### 2. テストの実行

```bash
# 全パッケージのテストを実行
uv run pytest

# 特定のパッケージのテストのみ実行
uv run --package shared-lib pytest

# カバレッジレポートを生成
uv run pytest --cov=shared_lib --cov-report=html
```

### 3. コード品質の管理

```bash
# コードフォーマット
uv run black .

# リント
uv run ruff check .

# 型チェック
uv run mypy .
```

## 高度な設定

### 1. 環境別の設定

```toml
# pyproject.toml
[tool.uv.workspace]
members = [
    "packages/*",
    "apps/*"
]

# 開発環境用の依存関係
[tool.uv]
dev-dependencies = [
    "pytest>=7.0.0",
    "black>=23.0.0",
    "ruff>=0.1.0",
    "mypy>=1.0.0",
    "pre-commit>=3.0.0"
]

# 本番環境用の依存関係
[tool.uv.production]
dependencies = [
    "gunicorn>=21.0.0"
]
```

### 2. スクリプトの定義

```toml
# pyproject.toml
[project.scripts]
dev = "uv run --package web-api uvicorn web_api.main:app --reload"
test = "uv run pytest"
lint = "uv run ruff check ."
format = "uv run black ."
typecheck = "uv run mypy ."
```

### 3. CI/CDの設定

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v1
        with:
          version: "latest"
      
      - name: Install dependencies
        run: uv sync
      
      - name: Run tests
        run: uv run pytest
      
      - name: Run linting
        run: uv run ruff check .
      
      - name: Run type checking
        run: uv run mypy .
```

## トラブルシューティング

### よくある問題と解決方法

1. **依存関係の競合**
   ```bash
   # ロックファイルを再生成
   uv lock --upgrade
   ```

2. **パッケージが見つからない**
   ```bash
   # ワークスペースを再同期
   uv sync --reinstall
   ```

3. **ビルドエラー**
   ```bash
   # キャッシュをクリア
   uv cache clean
   uv sync
   ```

## まとめ

uvのワークスペース機能を使ったmonorepoの構築について解説しました。主なポイントは以下の通りです：

- **ワークスペース設定**: `pyproject.toml`でワークスペースのメンバーを定義
- **依存関係の共有**: ワークスペース内のパッケージを相互参照
- **統一された開発環境**: 同じツールチェーンで全プロジェクトを管理
- **効率的なビルド**: 依存関係の最適化とキャッシュ機能

uvの高速性とワークスペース機能を活用することで、大規模なPythonプロジェクトを効率的に管理できます。複数のプロジェクトを扱う際は、ぜひuvのmonorepo機能を試してみてください。

## 参考リンク

- [uv公式ドキュメント](https://docs.astral.sh/uv/)
- [uvワークスペースガイド](https://docs.astral.sh/uv/guides/workspaces/)
- [Pythonプロジェクト管理のベストプラクティス](https://packaging.python.org/en/latest/tutorials/packaging-projects/)
