---
date: 2025-11-22
title: Ruby on Rails と OpenAPI で構築する型安全な REST API
description: Ruby on Rails と OpenAPI を組み合わせて、型安全で保守性の高い REST API を構築する方法を解説します。スキーマ駆動開発で API の品質を向上させる実践的なアプローチを紹介します。
tags:
  - ruby-on-rails
  - openapi
  - rest-api
  - api-design
  - schema-driven-development
prev:
  text: 'Effect入門：TypeScriptの次世代ライブラリで型安全な非同期処理を実現'
  link: '/posts/2025/11/17'
next:
  text: 'Drizzle ORM + sql.js でブラウザ上でSQLiteを動かす実践'
  link: '/posts/2025/11/26'
---

# Ruby on Rails と OpenAPI で構築する型安全な REST API

Ruby on Rails は Web アプリケーション開発のための強力なフレームワークであり、OpenAPI は API 仕様を記述するための業界標準規格です。この 2 つを組み合わせることで、型安全で保守性の高い REST API を効率的に構築できます。この記事では、Rails と OpenAPI を活用したスキーマ駆動開発の実践方法を解説します。

## Ruby on Rails とは

[Ruby on Rails](https://rubyonrails.org/) は、Ruby 言語で書かれた Web アプリケーションフレームワークです。2004 年に登場して以来、Basecamp、GitHub、Shopify など、多数の大規模サービスで採用されてきました。

### Rails の主な特徴

- **CoC（Convention over Configuration）**: 設定より規約を重視し、定型的な決定を最小化
- **DRY（Don't Repeat Yourself）**: 重複を避け、コードの保守性を向上
- **MVC アーキテクチャ**: Model、View、Controller による明確な責務分離
- **Active Record**: データベース操作を直感的に記述できる ORM
- **豊富な Gem エコシステム**: 再利用可能なライブラリが充実

## OpenAPI とは

OpenAPI Specification（OAS）は、REST API を記述するための標準仕様です。以前は Swagger Specification として知られていました。

### OpenAPI の主な利点

- **API 仕様の明確化**: エンドポイント、リクエスト/レスポンスの形式を厳密に定義
- **ドキュメント自動生成**: Swagger UI などで対話的なドキュメントを自動生成
- **コード生成**: クライアント SDK やサーバースタブを自動生成
- **バリデーション**: リクエスト/レスポンスの自動検証
- **チーム間の契約**: フロントエンドとバックエンドの開発を並行化

## Rails と OpenAPI を組み合わせるメリット

Rails と OpenAPI を組み合わせることで、以下のメリットが得られます。

### スキーマ駆動開発

API 仕様を先に定義し、それに基づいて実装を進めるスキーマ駆動開発が可能になります。これにより、仕様と実装の乖離を防ぎ、品質を向上させます。

### 型安全性の向上

OpenAPI スキーマに基づいて、リクエスト/レスポンスの型を厳密に定義できます。これにより、実行時エラーを減らし、開発者体験を向上させます。

### ドキュメントの自動生成

コードから OpenAPI 仕様を生成、または OpenAPI 仕様からコードを生成することで、ドキュメントとコードの同期を保ちます。

### フロントエンドとの連携強化

OpenAPI 仕様を共有することで、フロントエンドエンジニアは型安全なクライアントコードを自動生成でき、開発を並行化できます。

## 実装アプローチ

Rails と OpenAPI を組み合わせる実装アプローチには、主に 2 つの方向性があります。

### アプローチ 1: コードファースト

Rails のコードから OpenAPI 仕様を自動生成する方法です。`rswag` や `rspec_api_documentation` などの Gem を使用します。

**メリット**:

- Rails の開発フローに自然に統合
- 既存の Rails アプリケーションへの導入が容易

**デメリット**:

- 仕様と実装が乖離しやすい
- API 設計の初期段階で仕様を確定しにくい

### アプローチ 2: スキーマファースト

OpenAPI 仕様を先に定義し、そこから Rails のコードを生成、またはバリデーションを行う方法です。`openapi_first` や `committee` などの Gem を使用します。

**メリット**:

- API 設計を先に確定できる
- 仕様と実装の一貫性を保ちやすい
- フロントエンド開発との並行化が容易

**デメリット**:

- 初期セットアップにやや時間がかかる
- スキーマの保守が必要

本記事では、**スキーマファースト**のアプローチを推奨します。

## 実装手順

### 1. Rails プロジェクトのセットアップ

まず、新しい Rails プロジェクトを作成します。API モードで作成すると、不要な View 関連のコードを省略できます。

```bash
rails new myapi --api
cd myapi
```

### 2. 必要な Gem の追加

`Gemfile` に以下の Gem を追加します。

```ruby
# Gemfile
gem 'committee', '~> 5.0'
gem 'committee-rails', '~> 0.7'
gem 'openapi_first', '~> 1.0'
```

```bash
bundle install
```

### 3. OpenAPI 仕様の作成

`openapi.yaml` を作成し、API 仕様を定義します。

```yaml
openapi: 3.0.3
info:
  title: My API
  version: 1.0.0
  description: Ruby on Rails と OpenAPI を使った REST API の例

servers:
  - url: http://localhost:3000/api/v1
    description: Development server

paths:
  /users:
    get:
      summary: ユーザー一覧を取得
      operationId: listUsers
      tags:
        - users
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '400':
          $ref: '#/components/responses/BadRequest'

    post:
      summary: ユーザーを作成
      operationId: createUser
      tags:
        - users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /users/{id}:
    get:
      summary: ユーザー詳細を取得
      operationId: getUser
      tags:
        - users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: ユーザーを更新
      operationId: updateUser
      tags:
        - users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

    delete:
      summary: ユーザーを削除
      operationId: deleteUser
      tags:
        - users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: 削除成功
        '404':
          $ref: '#/components/responses/NotFound'

components:
  schemas:
    User:
      type: object
      required:
        - id
        - name
        - email
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: 'John Doe'
        email:
          type: string
          format: email
          example: 'john@example.com'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UserInput:
      type: object
      required:
        - name
        - email
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: 'John Doe'
        email:
          type: string
          format: email
          example: 'john@example.com'

    Pagination:
      type: object
      required:
        - current_page
        - total_pages
        - total_count
      properties:
        current_page:
          type: integer
          example: 1
        total_pages:
          type: integer
          example: 5
        total_count:
          type: integer
          example: 100

    Error:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          example: 'エラーが発生しました'
        errors:
          type: array
          items:
            type: string

  responses:
    BadRequest:
      description: リクエストが不正
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    UnprocessableEntity:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
```

### 4. Committee の設定

`config/initializers/committee.rb` を作成し、Committee を設定します。

```ruby
# config/initializers/committee.rb
Rails.application.config.middleware.use Committee::Middleware::RequestValidation,
  schema_path: Rails.root.join('openapi.yaml').to_s,
  strict: true,
  parse_response_by_content_type: true
```

### 5. Model の作成

User モデルを作成します。

```bash
rails generate model User name:string email:string
rails db:migrate
```

```ruby
# app/models/user.rb
class User < ApplicationRecord
  validates :name, presence: true, length: { maximum: 100 }
  validates :email, presence: true, format: { with: URI::MailTo::EMAIL_REGEXP }
  validates :email, uniqueness: true
end
```

### 6. Controller の実装

OpenAPI 仕様に基づいて Controller を実装します。

```ruby
# app/controllers/api/v1/users_controller.rb
module Api
  module V1
    class UsersController < ApplicationController
      before_action :set_user, only: [:show, :update, :destroy]

      # GET /api/v1/users
      def index
        page = params[:page]&.to_i || 1
        per_page = [params[:per_page]&.to_i || 20, 100].min

        users = User.page(page).per(per_page)
        total_count = User.count

        render json: {
          users: users.as_json(only: [:id, :name, :email, :created_at, :updated_at]),
          pagination: {
            current_page: page,
            total_pages: (total_count.to_f / per_page).ceil,
            total_count: total_count
          }
        }
      end

      # GET /api/v1/users/:id
      def show
        render json: @user.as_json(only: [:id, :name, :email, :created_at, :updated_at])
      end

      # POST /api/v1/users
      def create
        user = User.new(user_params)

        if user.save
          render json: user.as_json(only: [:id, :name, :email, :created_at, :updated_at]),
                 status: :created
        else
          render json: {
            message: 'バリデーションエラー',
            errors: user.errors.full_messages
          }, status: :unprocessable_entity
        end
      end

      # PATCH /api/v1/users/:id
      def update
        if @user.update(user_params)
          render json: @user.as_json(only: [:id, :name, :email, :created_at, :updated_at])
        else
          render json: {
            message: 'バリデーションエラー',
            errors: @user.errors.full_messages
          }, status: :unprocessable_entity
        end
      end

      # DELETE /api/v1/users/:id
      def destroy
        @user.destroy
        head :no_content
      end

      private

      def set_user
        @user = User.find(params[:id])
      rescue ActiveRecord::RecordNotFound
        render json: {
          message: 'ユーザーが見つかりません'
        }, status: :not_found
      end

      def user_params
        params.require(:user).permit(:name, :email)
      end
    end
  end
end
```

### 7. Routes の設定

```ruby
# config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    namespace :v1 do
      resources :users
    end
  end
end
```

### 8. テストの実装

RSpec で OpenAPI スキーマに基づいたテストを実装します。

```ruby
# spec/requests/api/v1/users_spec.rb
require 'rails_helper'

RSpec.describe 'Api::V1::Users', type: :request do
  describe 'GET /api/v1/users' do
    before do
      create_list(:user, 25)
    end

    it 'returns users list' do
      get '/api/v1/users', params: { page: 1, per_page: 20 }

      expect(response).to have_http_status(:ok)
      json = JSON.parse(response.body)

      expect(json['users'].size).to eq(20)
      expect(json['pagination']['current_page']).to eq(1)
      expect(json['pagination']['total_count']).to eq(25)
    end

    it 'validates against OpenAPI schema' do
      get '/api/v1/users'

      expect(response).to have_http_status(:ok)
      assert_response_schema_confirm(200)
    end
  end

  describe 'POST /api/v1/users' do
    let(:valid_params) do
      { user: { name: 'John Doe', email: 'john@example.com' } }
    end

    it 'creates a new user' do
      expect {
        post '/api/v1/users', params: valid_params, as: :json
      }.to change(User, :count).by(1)

      expect(response).to have_http_status(:created)
      json = JSON.parse(response.body)
      expect(json['name']).to eq('John Doe')
      expect(json['email']).to eq('john@example.com')
    end

    it 'returns error for invalid params' do
      post '/api/v1/users', params: { user: { name: '' } }, as: :json

      expect(response).to have_http_status(:unprocessable_entity)
      json = JSON.parse(response.body)
      expect(json['errors']).to be_present
    end
  end
end
```

## Swagger UI でのドキュメント表示

OpenAPI 仕様を Swagger UI で表示することで、対話的な API ドキュメントを提供できます。

```ruby
# Gemfile に追加
gem 'rswag-ui'
```

```ruby
# config/initializers/rswag_ui.rb
Rswag::Ui.configure do |c|
  c.swagger_endpoint '/openapi.yaml', 'API V1 Docs'
end
```

`/api-docs` エンドポイントにアクセスすると、Swagger UI が表示されます。

## ベストプラクティス

### バージョニング

API のバージョンを URL に含めることで、後方互換性を保ちます。

```ruby
# config/routes.rb
namespace :api do
  namespace :v1 do
    resources :users
  end

  namespace :v2 do
    resources :users
  end
end
```

### エラーハンドリング

一貫したエラーレスポンスを返すように、`ApplicationController` で共通処理を実装します。

```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::API
  rescue_from ActiveRecord::RecordNotFound, with: :not_found
  rescue_from ActionController::ParameterMissing, with: :bad_request

  private

  def not_found
    render json: { message: 'リソースが見つかりません' }, status: :not_found
  end

  def bad_request
    render json: { message: 'リクエストが不正です' }, status: :bad_request
  end
end
```

### ペジネーション

大量のデータを返す場合は、ペジネーションを実装します。`kaminari` gem を使用すると便利です。

```ruby
# Gemfile
gem 'kaminari'
```

### レート制限

`rack-attack` gem を使用して、API へのアクセスをレート制限します。

```ruby
# Gemfile
gem 'rack-attack'
```

```ruby
# config/initializers/rack_attack.rb
Rack::Attack.throttle('api/ip', limit: 100, period: 1.minute) do |req|
  req.ip if req.path.start_with?('/api/')
end
```

## まとめ

Ruby on Rails と OpenAPI を組み合わせることで、型安全で保守性の高い REST API を構築できます。

**主要なポイント**:

- **スキーマファースト**: OpenAPI 仕様を先に定義し、実装との一貫性を保つ
- **バリデーション**: Committee を使用してリクエスト/レスポンスを自動検証
- **ドキュメント**: Swagger UI で対話的な API ドキュメントを提供
- **テスト**: OpenAPI スキーマに基づいたテストで品質を担保
- **チーム連携**: フロントエンドとバックエンドの開発を並行化

**実装時の推奨事項**:

- API のバージョニングを適切に行う
- 一貫したエラーレスポンスを返す
- ペジネーションとレート制限を実装する
- OpenAPI 仕様とコードの同期を保つ
- RSpec で OpenAPI スキーマに基づいたテストを実装する

Rails と OpenAPI を活用することで、開発効率と API の品質を同時に向上させることができます。詳細は [Ruby on Rails 公式サイト](https://rubyonrails.org/) と [OpenAPI Specification](https://spec.openapis.org/oas/latest.html) を参照してください。
