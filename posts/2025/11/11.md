---
date: 2025-11-11
title: ogenでOpenAPIからGoコードを生成：型安全で高速なAPI開発の実践
description: ogenはOpenAPI v3仕様からGoのコードを自動生成するツールです。リフレクションを使わず、ボイラープレートコードなしで型安全なAPIクライアント・サーバーを実装できます。ogenの特徴、使い方、実践的なコード例を詳しく解説します。
tags:
  - go
  - openapi
  - code-generation
  - golang
  - api-development
  - type-safety
  - openapi-generator
prev:
  text: 'APIリクエストを型安全にする実践的手法：TypeScriptで堅牢なAPI通信を実現'
  link: '/posts/2025/11/10'
next:
  text: 'Effect入門：TypeScriptの次世代ライブラリで型安全な非同期処理を実現'
  link: '/posts/2025/11/17'
---

# ogenでOpenAPIからGoコードを生成：型安全で高速なAPI開発の実践

[ogen](https://ogen.dev/)は、OpenAPI v3仕様からGoのコードを自動生成するツールです。リフレクションを使わず、ボイラープレートコードなしで、型安全で高速なAPIクライアントとサーバーを実装できます。この記事では、ogenの特徴と実践的な使い方を、コード例と共に詳しく解説します。

## ogenとは

ogenは、OpenAPI v3仕様を読み込んで、Goの型定義、バリデーション、エンコーディング/デコーディングのコードを自動生成するツールです。生成されたコードは最適化されており、`encoding/json`の制限を克服するために`jx`を使用します。

### 主な特徴

- **リフレクション不使用**: コード生成により最適化されたJSONエンコーディング
- **ボイラープレートコードなし**: OpenAPI仕様から構造体を自動生成
- **型安全性**: 文字列フォーマット（`uuid`、`date`、`date-time`、`uri`）をGoの型で直接表現
- **Sum型のサポート**: OneOf、discriminator、暗黙的な型推論に対応
- **ポインタ不要のオプショナル**: 可能な限りポインタを使わずにオプショナルとnullableをサポート
- **OpenTelemetry対応**: トレーシングとメトリクスのサポート

## インストール

ogenはGoのバイナリとして提供されており、以下の方法でインストールできます。

```bash
# Go 1.21以降が必要
go install github.com/ogen-go/ogen/cmd/ogen@latest

# バージョン確認
ogen --version
```

## 基本的な使い方

### OpenAPI仕様の準備

まず、OpenAPI v3の仕様ファイルを準備します。

```yaml
# api.yaml
openapi: 3.0.0
info:
  title: User API
  version: 1.0.0
paths:
  /users:
    get:
      summary: ユーザー一覧を取得
      operationId: getUsers
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      summary: ユーザーを作成
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
  /users/{id}:
    get:
      summary: ユーザーを取得
      operationId: getUser
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
components:
  schemas:
    User:
      type: object
      required:
        - id
        - name
        - email
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
    CreateUserRequest:
      type: object
      required:
        - name
        - email
      properties:
        name:
          type: string
        email:
          type: string
          format: email
```

### コード生成

ogenを使用してGoのコードを生成します。

```bash
# クライアントとサーバーの両方を生成
ogen --target api --package api api.yaml

# クライアントのみを生成
ogen --target client --package client api.yaml

# サーバーのみを生成
ogen --target server --package server api.yaml
```

### 生成されるコードの構造

ogenは以下のような構造でコードを生成します。

```
api/
├── api.gen.go          # 生成されたAPIインターフェース
├── oas.gen.go          # OpenAPI仕様の定義
├── ogent.gen.go        # 型定義とバリデーション
└── ...
```

## クライアントの実装

生成されたクライアントを使用してAPIを呼び出します。

```go
package main

import (
    "context"
    "fmt"
    "log"

    "github.com/your-project/api"
)

func main() {
    // クライアントの作成
    client, err := api.NewClient("https://api.example.com", api.ClientOptions{})
    if err != nil {
        log.Fatal(err)
    }

    ctx := context.Background()

    // ユーザー一覧を取得
    users, err := client.GetUsers(ctx)
    if err != nil {
        log.Fatal(err)
    }

    for _, user := range users {
        fmt.Printf("ID: %d, Name: %s, Email: %s\n",
            user.ID, user.Name, user.Email)
    }

    // ユーザーを作成
    newUser, err := client.CreateUser(ctx, api.CreateUserRequest{
        Name:  "John Doe",
        Email:  "john@example.com",
    })
    if err != nil {
        log.Fatal(err)
    }

    fmt.Printf("Created user: %+v\n", newUser)

    // 特定のユーザーを取得
    user, err := client.GetUser(ctx, api.GetUserParams{
        ID: 1,
    })
    if err != nil {
        log.Fatal(err)
    }

    fmt.Printf("User: %+v\n", user)
}
```

## サーバーの実装

生成されたサーバーインターフェースを実装します。

```go
package main

import (
    "context"
    "fmt"
    "net/http"

    "github.com/your-project/api"
)

// UserServiceは生成されたインターフェースを実装
type UserService struct {
    users []api.User
}

func (s *UserService) GetUsers(ctx context.Context) ([]api.User, error) {
    return s.users, nil
}

func (s *UserService) CreateUser(ctx context.Context, req api.CreateUserRequest) (*api.User, error) {
    newUser := api.User{
        ID:        int64(len(s.users) + 1),
        Name:      req.Name,
        Email:     req.Email,
        CreatedAt: time.Now(),
    }
    s.users = append(s.users, newUser)
    return &newUser, nil
}

func (s *UserService) GetUser(ctx context.Context, params api.GetUserParams) (*api.User, error) {
    for _, user := range s.users {
        if user.ID == params.ID {
            return &user, nil
        }
    }
    return nil, api.ErrNotFound
}

func main() {
    service := &UserService{
        users: []api.User{},
    }

    // サーバーハンドラーを生成
    handler, err := api.NewServer(service)
    if err != nil {
        log.Fatal(err)
    }

    // HTTPサーバーを起動
    http.Handle("/", handler)
    fmt.Println("Server starting on :8080")
    if err := http.ListenAndServe(":8080", nil); err != nil {
        log.Fatal(err)
    }
}
```

## 型安全性の特徴

### フォーマット済み文字列の型

ogenは、OpenAPI仕様の文字列フォーマットをGoの型で直接表現します。

```go
// OpenAPI仕様で format: uuid と指定された場合
type UserID uuid.UUID

// OpenAPI仕様で format: date-time と指定された場合
type CreatedAt time.Time

// OpenAPI仕様で format: uri と指定された場合
type ImageURL url.URL
```

### OneOfとSum型

ogenは、OneOfスキーマをSum型として生成します。

```yaml
components:
  schemas:
    ErrorResponse:
      oneOf:
        - $ref: '#/components/schemas/ValidationError'
        - $ref: '#/components/schemas/NotFoundError'
        - $ref: '#/components/schemas/InternalError'
      discriminator:
        propertyName: type
        mapping:
          validation: '#/components/schemas/ValidationError'
          notFound: '#/components/schemas/NotFoundError'
          internal: '#/components/schemas/InternalError'
```

生成されるGoコード：

```go
type ErrorResponse struct {
    ValidationError *ValidationError
    NotFoundError   *NotFoundError
    InternalError   *InternalError
}

// 型安全な分岐
switch {
case resp.ValidationError != nil:
    // ValidationErrorの処理
case resp.NotFoundError != nil:
    // NotFoundErrorの処理
case resp.InternalError != nil:
    // InternalErrorの処理
}
```

### オプショナルとNullable

ogenは、可能な限りポインタを使わずにオプショナルとnullableをサポートします。

```go
// オプショナルなフィールド（ポインタ不要）
type User struct {
    ID        int64
    Name      string
    Email     string
    Bio       opt.String  // オプショナルな文字列
    AvatarURL opt.URI     // オプショナルなURI
}
```

## バリデーション

ogenは、OpenAPI仕様に基づいてバリデーションコードを生成します。

```go
// 生成されたバリデーションコード
func (r CreateUserRequest) Validate() error {
    if len(r.Name) < 1 {
        return errors.New("name: string length must be >= 1")
    }
    if !emailRegex.MatchString(r.Email) {
        return errors.New("email: invalid email format")
    }
    return nil
}
```

## OpenTelemetry対応

ogenは、OpenTelemetryとの統合をサポートしています。

```go
import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/trace"
)

func main() {
    // OpenTelemetryのトレーサーを設定
    tracer := otel.Tracer("api-client")

    client, err := api.NewClient("https://api.example.com", api.ClientOptions{
        Tracer: tracer,
    })
    if err != nil {
        log.Fatal(err)
    }

    ctx := context.Background()

    // トレーシングが自動的に有効になる
    users, err := client.GetUsers(ctx)
    if err != nil {
        log.Fatal(err)
    }
}
```

## 実践的なワークフロー

### 1. OpenAPI仕様の作成・更新

```bash
# OpenAPI仕様を編集
vim api.yaml

# 仕様の検証（任意）
npx @redocly/cli lint api.yaml
```

### 2. コード生成

```bash
# Makefileに追加
generate:
    ogen --target api --package api api.yaml

# または、go generateを使用
#go:generate ogen --target api --package api api.yaml
```

### 3. 実装とテスト

```go
// 生成されたコードを使用して実装
// テストを書く
```

### 4. CI/CDでの自動生成

```yaml
# .github/workflows/generate.yml
name: Generate Code
on:
  push:
    paths:
      - 'api.yaml'
jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - run: go install github.com/ogen-go/ogen/cmd/ogen@latest
      - run: ogen --target api --package api api.yaml
      - run: git diff --exit-code || (echo "Generated code is out of date" && exit 1)
```

## 他のツールとの比較

### ogen vs openapi-generator

- **ogen**: Go専用、リフレクション不使用、高速
- **openapi-generator**: 多言語対応、リフレクション使用、柔軟性が高い

### ogen vs go-swagger

- **ogen**: OpenAPI v3専用、モダンなアプローチ
- **go-swagger**: Swagger 2.0対応、レガシーなプロジェクトで使用

## まとめ

ogenは、OpenAPI v3仕様からGoのコードを生成する強力なツールです。

**主要なポイント**:

- **リフレクション不使用**: コード生成により最適化されたパフォーマンス
- **型安全性**: フォーマット済み文字列をGoの型で直接表現
- **ボイラープレートコードなし**: OpenAPI仕様から自動生成
- **OpenTelemetry対応**: トレーシングとメトリクスのサポート
- **Sum型のサポート**: OneOfを型安全に扱える

**実装時の推奨事項**:

- OpenAPI仕様を正確に記述する
- CI/CDでコード生成を自動化する
- 生成されたコードを直接編集しない
- バリデーションは生成されたコードを活用する

ogenを活用することで、型安全で高速なAPIクライアントとサーバーを効率的に実装できます。詳細は[ogen公式サイト](https://ogen.dev/)を参照してください。
