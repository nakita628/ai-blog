---
date: 2025-11-26
title: Drizzle ORM + sql.js でブラウザ上でSQLiteを動かす実践
description: Drizzle ORMとsql.jsを組み合わせることで、ブラウザ上で完全に動作するSQLiteデータベースを実現できます。Northwindデータセットを使った実装例とともに、ブラウザ内データベースの新しい可能性を解説します。
tags:
  - drizzle-orm
  - sql.js
  - sqlite
  - typescript
  - browser-database
prev:
  text: 'Ruby on Rails と OpenAPI で構築する型安全な REST API'
  link: '/posts/2025/11/22'
next:
  text: 'Laravel：PHP開発者のための完全なエコシステム'
  link: '/posts/2025/11/27'
---

# Drizzle ORM + sql.js でブラウザ上でSQLiteを動かす実践

Drizzle ORMとsql.jsを組み合わせることで、ブラウザ上で完全に動作するSQLiteデータベースを実現できます。この記事では、[drizzle-sqljs](https://github.com/drizzle-team/drizzle-sqljs)プロジェクトを題材に、ブラウザ内データベースの実装方法と活用シーンを解説します。

## drizzle-sqljsプロジェクトとは

drizzle-sqljsは、Drizzle ORMとsql.jsを組み合わせた実践的なデモプロジェクトです。

主な特徴は以下の通りです。

- **ブラウザ完結**: サーバー不要でSQLiteが動作
- **Northwindデータセット**: 実践的なサンプルデータを使用
- **UIデザイン**: Cloudflare D1の例を参考にした洗練されたインターフェース
- **データ探索**: Supplies、Orders、Customers、Employees、Productsを対話的に探索可能

## なぜブラウザでSQLiteを動かすのか

ブラウザ上でSQLiteを動作させることには、以下のメリットがあります。

### オフラインファースト

ネットワーク接続なしでも完全に動作するアプリケーションを構築できます。PWA（Progressive Web App）との組み合わせにより、ネイティブアプリに近い体験を提供します。

### サーバーコストの削減

クライアント側でデータ処理が完結するため、サーバーへの負荷が大幅に軽減されます。特にデータ分析やレポート生成などの処理を、クライアント側で実行できます。

### プライバシー保護

データがブラウザ内に閉じるため、機密情報を外部に送信する必要がありません。医療や金融などのプライバシー要求の高い分野で有効です。

### デモとプロトタイピング

API実装なしで、完全に動作するデータベースアプリケーションを素早く構築できます。クライアントへのデモやプロトタイプ開発に最適です。

## sql.jsとは

[sql.js](https://github.com/sql-js/sql.js)は、SQLiteをWebAssemblyにコンパイルしたライブラリです。

```ts
import initSqlJs from 'sql.js'

const SQL = await initSqlJs({
  locateFile: (file) => `https://sql.js.org/dist/${file}`,
})

const db = new SQL.Database()
```

SQLiteの全機能をブラウザで利用できるため、以下が可能になります。

- トランザクション処理
- インデックスによる高速検索
- JOIN、GROUP BY、サブクエリなどの複雑なクエリ
- トリガーやビューの作成

## Drizzle ORMとの統合

Drizzle ORMは、TypeScriptファーストの軽量ORMです。sql.jsとの組み合わせにより、型安全なデータベース操作が実現します。

### スキーマ定義

Drizzleのスキーマ定義は、直感的で型安全です。

```ts
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core'

export const users = sqliteTable('users', {
  id: integer('id').primaryKey(),
  name: text('name').notNull(),
  email: text('email').notNull().unique(),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
})

export const orders = sqliteTable('orders', {
  id: integer('id').primaryKey(),
  userId: integer('user_id')
    .notNull()
    .references(() => users.id),
  amount: integer('amount').notNull(),
  status: text('status', { enum: ['pending', 'completed', 'cancelled'] }).notNull(),
  orderedAt: integer('ordered_at', { mode: 'timestamp' }).notNull(),
})
```

### クエリの実行

Drizzle ORMのクエリビルダーは、SQLに近い記述で型安全性を提供します。

```ts
import { drizzle } from 'drizzle-orm/sql-js'
import { eq, and, gte } from 'drizzle-orm'

const db = drizzle(sqliteDb)

// SELECT * FROM users WHERE email = 'user@example.com'
const user = await db.select().from(users).where(eq(users.email, 'user@example.com')).get()

// JOIN クエリ
const ordersWithUsers = await db
  .select({
    orderId: orders.id,
    userName: users.name,
    amount: orders.amount,
  })
  .from(orders)
  .innerJoin(users, eq(orders.userId, users.id))
  .where(gte(orders.amount, 1000))
  .all()
```

Drizzleは自動補完とランタイムの型チェックを提供するため、開発効率が向上します。

## Northwindデータセットの活用

drizzle-sqljsプロジェクトは、Northwindデータセットを使用しています。

Northwindは、Microsoftが提供する架空の貿易会社のデータベースで、以下のテーブルを含みます。

- **Customers**: 顧客情報
- **Orders**: 注文情報
- **OrderDetails**: 注文明細
- **Products**: 商品情報
- **Suppliers**: 供給業者情報
- **Employees**: 従業員情報
- **Categories**: 商品カテゴリ

この構造により、実践的なリレーショナルデータベースの操作を学べます。

### データの初期化

ブラウザ起動時に、SQLファイルからデータを読み込みます。

```ts
import initSqlJs from 'sql.js'
import { drizzle } from 'drizzle-orm/sql-js'

async function initializeDatabase() {
  const SQL = await initSqlJs({
    locateFile: (file) => `https://sql.js.org/dist/${file}`,
  })

  const sqliteDb = new SQL.Database()

  // Northwindデータのインポート
  const response = await fetch('/data/northwind.sql')
  const sql = await response.text()
  sqliteDb.run(sql)

  const db = drizzle(sqliteDb)
  return db
}
```

## 実装例：注文検索機能

以下は、注文を検索する機能の実装例です。

```ts
import { drizzle } from 'drizzle-orm/sql-js'
import { eq, like, and, gte, lte } from 'drizzle-orm'
import { orders, customers, orderDetails, products } from './schema'

interface SearchParams {
  customerId?: number
  startDate?: Date
  endDate?: Date
  minAmount?: number
  productName?: string
}

async function searchOrders(db: ReturnType<typeof drizzle>, params: SearchParams) {
  let query = db
    .select({
      orderId: orders.id,
      orderDate: orders.orderedAt,
      customerName: customers.companyName,
      totalAmount: orders.amount,
      productCount: sql`COUNT(${orderDetails.id})`,
    })
    .from(orders)
    .innerJoin(customers, eq(orders.customerId, customers.id))
    .leftJoin(orderDetails, eq(orders.id, orderDetails.orderId))
    .groupBy(orders.id)

  const conditions = []

  if (params.customerId) {
    conditions.push(eq(orders.customerId, params.customerId))
  }

  if (params.startDate) {
    conditions.push(gte(orders.orderedAt, params.startDate))
  }

  if (params.endDate) {
    conditions.push(lte(orders.orderedAt, params.endDate))
  }

  if (params.minAmount) {
    conditions.push(gte(orders.amount, params.minAmount))
  }

  if (params.productName) {
    query = query
      .innerJoin(products, eq(orderDetails.productId, products.id))
      .where(like(products.name, `%${params.productName}%`))
  }

  if (conditions.length > 0) {
    query = query.where(and(...conditions))
  }

  return query.all()
}
```

この実装により、複雑な検索条件でもブラウザ内で高速に処理できます。

## UIの実装

drizzle-sqljsプロジェクトは、Cloudflare D1のUIデザインを参考にしています。

React/Vueなどのフレームワークと組み合わせることで、以下のような機能を実装できます。

- テーブル一覧の表示
- 行のフィルタリングとソート
- データの編集と削除
- SQLクエリの直接実行
- データのエクスポート（CSV/JSON）

```tsx
import { useState, useEffect } from 'react'

function OrdersTable({ db }) {
  const [orders, setOrders] = useState([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function loadOrders() {
      const result = await db.select().from(orders).limit(100).all()

      setOrders(result)
      setLoading(false)
    }

    loadOrders()
  }, [db])

  if (loading) return <div>Loading...</div>

  return (
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {orders.map((order) => (
          <tr key={order.id}>
            <td>{order.id}</td>
            <td>{order.customerId}</td>
            <td>${order.amount}</td>
            <td>{order.status}</td>
          </tr>
        ))}
      </tbody>
    </table>
  )
}
```

## パフォーマンスの考慮

ブラウザ上でSQLiteを動かす際は、以下のパフォーマンス最適化が重要です。

### 1. データサイズの制限

sql.jsはメモリ内でデータベースを保持するため、データサイズに制限があります。目安として、数MB〜数十MB程度が現実的です。

### 2. インデックスの活用

頻繁に検索するカラムにはインデックスを作成します。

```ts
export const users = sqliteTable(
  'users',
  {
    id: integer('id').primaryKey(),
    email: text('email').notNull().unique(),
    name: text('name').notNull(),
  },
  (table) => ({
    emailIdx: index('email_idx').on(table.email),
    nameIdx: index('name_idx').on(table.name),
  }),
)
```

### 3. ページネーション

大量のデータを扱う場合は、ページネーションを実装します。

```ts
const page = 1
const pageSize = 20

const paginatedOrders = await db
  .select()
  .from(orders)
  .limit(pageSize)
  .offset((page - 1) * pageSize)
  .all()
```

### 4. 永続化

LocalStorageやIndexedDBと連携することで、ページリロード後もデータを保持できます。

```ts
import initSqlJs from 'sql.js'

async function saveDatabase(db: Database) {
  const data = db.export()
  const buffer = Buffer.from(data)
  localStorage.setItem('sqliteDb', buffer.toString('base64'))
}

async function loadDatabase() {
  const SQL = await initSqlJs()
  const saved = localStorage.getItem('sqliteDb')

  if (saved) {
    const buffer = Buffer.from(saved, 'base64')
    return new SQL.Database(buffer)
  }

  return new SQL.Database()
}
```

## セットアップ手順

drizzle-sqljsプロジェクトをローカルで動かす手順は以下の通りです。

```bash
git clone https://github.com/drizzle-team/drizzle-sqljs.git
cd drizzle-sqljs
npm install
npm run dev
```

この手順で、ローカル開発サーバーが起動し、ブラウザでNorthwindデータベースを探索できます。

## 活用シーン

Drizzle ORM + sql.jsの組み合わせは、以下のシーンで有効です。

### データ分析ツール

CSVやJSONをインポートし、ブラウザ内でSQLクエリを実行してデータを分析できます。

### オフラインアプリ

ネットワーク接続なしで動作するタスク管理や在庫管理アプリを構築できます。

### エディターの拡張

VS CodeやCursorなどのエディター拡張として、SQLiteデータベースを直接操作できます。

### 教育とデモ

SQLやデータベース設計を学ぶためのインタラクティブなチュートリアルを提供できます。

## まとめ

Drizzle ORMとsql.jsを組み合わせることで、ブラウザ上で型安全かつ高機能なSQLiteデータベースを実現できます。

**主要なポイント**:

- **オフラインファースト**: サーバー不要で完全に動作
- **型安全**: Drizzle ORMによる完全な型推論
- **実践的**: Northwindデータセットで学べる
- **パフォーマンス**: インデックスとページネーションで最適化
- **永続化**: LocalStorage/IndexedDBで状態保存

**活用シーン**:

- データ分析ツール
- オフライン対応アプリ
- エディター拡張
- 教育・デモ

詳細は[drizzle-sqljs GitHubリポジトリ](https://github.com/drizzle-team/drizzle-sqljs)を参照してください。ブラウザ内データベースの新しい可能性を体験できます。
