---
date: 2025-09-06
title: tRPCå®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼šå‹å®‰å…¨ãªAPIé–‹ç™ºã§é–‹ç™ºåŠ¹ç‡ã‚’æœ€å¤§åŒ–ã™ã‚‹æ–¹æ³•
description: tRPCã‚’ä½¿ã£ãŸå‹å®‰å…¨ãªAPIé–‹ç™ºã®åŸºæœ¬ã‹ã‚‰å¿œç”¨ã¾ã§è§£èª¬ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–“ã®å‹å®‰å…¨æ€§ã‚’å®Ÿç¾ã—ã€é–‹ç™ºåŠ¹ç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹å®Ÿè·µçš„ãªæ‰‹æ³•ã€‚
tags:
  - trpc
  - typescript
  - api
  - fullstack
  - type-safety
  - backend
  - frontend
  - web-development
prev:
  text: 'React Three Fiberå®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼š3Dã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’Reactã§ç°¡å˜ã«å®Ÿç¾ã™ã‚‹æ–¹æ³•'
  link: '/posts/2025/09/04'
next:
  text: 'Google Cloud ã¨ GitHub Actions ã®çµ„ã¿åˆã‚ã›æ–¹ï¼šåˆå¿ƒè€…å‘ã‘å®Œå…¨ã‚¬ã‚¤ãƒ‰'
  link: '/posts/2025/09/07'
---

# tRPCå®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼šå‹å®‰å…¨ãªAPIé–‹ç™ºã§é–‹ç™ºåŠ¹ç‡ã‚’æœ€å¤§åŒ–ã™ã‚‹æ–¹æ³•

[tRPC](https://trpc.io/)ã¯ã€TypeScriptã®å‹æ¨è«–ã‚’æ´»ç”¨ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–“ã®å‹å®‰å…¨æ€§ã‚’å®Ÿç¾ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€å¾“æ¥ã®APIé–‹ç™ºã®èª²é¡Œã‚’è§£æ±ºã—ã€é–‹ç™ºåŠ¹ç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹tRPCã®ä½¿ã„æ–¹ã‚’å®Ÿè·µçš„ã«è§£èª¬ã—ã¾ã™ã€‚

## tRPCã¨ã¯

### æ¦‚è¦

tRPCã¯ã€ŒTypeScript Remote Procedure Callã€ã®ç•¥ã§ã€ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ï¼š

- **å‹å®‰å…¨æ€§**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–“ã§å®Œå…¨ãªå‹å®‰å…¨æ€§ã‚’å®Ÿç¾
- **ã‚¼ãƒ­è¨­å®š**: ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã‚„ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒä¸è¦
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯éä¾å­˜**: Reactã€Next.jsã€Expressã€Fastifyãªã©ã«å¯¾å¿œ
- **è»½é‡**: ä¾å­˜é–¢ä¿‚ãŒå°‘ãªãã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã„
- **å„ªã‚ŒãŸDX**: è‡ªå‹•è£œå®Œã¨IntelliSenseã‚’æä¾›

### å¾“æ¥ã®APIé–‹ç™ºã®èª²é¡Œ

**å¾“æ¥ã®REST API**

```typescript
// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
app.get('/api/users/:id', (req, res) => {
  const user = getUserById(req.params.id)
  res.json(user)
})

// ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
const response = await fetch('/api/users/123')
const user = await response.json() // anyå‹ã€å‹å®‰å…¨æ€§ãªã—
```

**tRPC**

```typescript
// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
const userRouter = t.router({
  getById: t.procedure
    .input(z.object({ id: z.string() }))
    .query(({ input }) => getUserById(input.id)),
})

// ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
const user = await trpc.user.getById.query({ id: '123' }) // å®Œå…¨ãªå‹å®‰å…¨æ€§
```

## åŸºæœ¬çš„ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
npm install @trpc/server @trpc/client

# ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
npm install zod

# Reactç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
npm install @trpc/react-query @tanstack/react-query

# Next.jsç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
npm install @trpc/next
```

### 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
src/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ user.router.ts
â”‚   â”‚   â”œâ”€â”€ post.router.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ trpc.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ trpc.ts
â”‚   â””â”€â”€ providers.tsx
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ types.ts
â”‚   â””â”€â”€ validators.ts
â””â”€â”€ pages/
    â””â”€â”€ api/
        â””â”€â”€ trpc/
            â””â”€â”€ [trpc].ts
```

## åŸºæœ¬çš„ãªtRPC API

### 1. ã‚µãƒ¼ãƒãƒ¼å´ã®è¨­å®š

```typescript
// src/server/trpc.ts
import { initTRPC } from '@trpc/server'
import { z } from 'zod'

// tRPCã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
const t = initTRPC.create()

// ãƒ«ãƒ¼ã‚¿ãƒ¼ã¨ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®ä½œæˆ
export const router = t.router
export const publicProcedure = t.procedure

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä¾‹
const loggingMiddleware = t.middleware(async ({ next, path }) => {
  const start = Date.now()
  const result = await next()
  const duration = Date.now() - start
  console.log(`${path} took ${duration}ms`)
  return result
})

export const loggedProcedure = publicProcedure.use(loggingMiddleware)
```

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ«ãƒ¼ã‚¿ãƒ¼

```typescript
// src/server/routers/user.router.ts
import { z } from 'zod'
import { router, publicProcedure, loggedProcedure } from '../trpc'

// ä»®æƒ³çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
const users = [
  { id: '1', name: 'Alice', email: 'alice@example.com', age: 25 },
  { id: '2', name: 'Bob', email: 'bob@example.com', age: 30 },
  { id: '3', name: 'Charlie', email: 'charlie@example.com', age: 35 },
]

export const userRouter = router({
  // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
  getAll: publicProcedure.query(() => {
    return users
  }),

  // IDã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
  getById: publicProcedure.input(z.object({ id: z.string() })).query(({ input }) => {
    const user = users.find((u) => u.id === input.id)
    if (!user) {
      throw new Error('User not found')
    }
    return user
  }),

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
  create: loggedProcedure
    .input(
      z.object({
        name: z.string().min(1),
        email: z.string().email(),
        age: z.number().min(0).max(120),
      }),
    )
    .mutation(({ input }) => {
      const newUser = {
        id: String(users.length + 1),
        ...input,
      }
      users.push(newUser)
      return newUser
    }),

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
  update: loggedProcedure
    .input(
      z.object({
        id: z.string(),
        name: z.string().min(1).optional(),
        email: z.string().email().optional(),
        age: z.number().min(0).max(120).optional(),
      }),
    )
    .mutation(({ input }) => {
      const userIndex = users.findIndex((u) => u.id === input.id)
      if (userIndex === -1) {
        throw new Error('User not found')
      }

      users[userIndex] = { ...users[userIndex], ...input }
      return users[userIndex]
    }),

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
  delete: loggedProcedure.input(z.object({ id: z.string() })).mutation(({ input }) => {
    const userIndex = users.findIndex((u) => u.id === input.id)
    if (userIndex === -1) {
      throw new Error('User not found')
    }

    const deletedUser = users.splice(userIndex, 1)[0]
    return deletedUser
  }),
})
```

### 3. ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ã‚¿ãƒ¼

```typescript
// src/server/routers/index.ts
import { router } from '../trpc'
import { userRouter } from './user.router'
import { postRouter } from './post.router'

export const appRouter = router({
  user: userRouter,
  post: postRouter,
})

export type AppRouter = typeof appRouter
```

### 4. ã‚µãƒ¼ãƒãƒ¼èµ·å‹•

```typescript
// src/server/index.ts
import { createHTTPServer } from '@trpc/server/adapters/standalone'
import { appRouter } from './routers'

const server = createHTTPServer({
  router: appRouter,
})

const port = process.env.PORT || 3001
server.listen(port, () => {
  console.log(`ğŸš€ tRPC server running on port ${port}`)
})
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¨­å®š

### 1. tRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

```typescript
// src/client/trpc.ts
import { createTRPCClient, httpBatchLink } from '@trpc/client'
import type { AppRouter } from '../server/routers'

export const trpc = createTRPCClient<AppRouter>({
  links: [
    httpBatchLink({
      url: 'http://localhost:3001',
    }),
  ],
})
```

### 2. Reactç”¨ã®è¨­å®š

```typescript
// src/client/providers.tsx
import React, { useState } from 'react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { trpc, createTRPCReact } from './trpc';
import type { AppRouter } from '../server/routers';

// Reactç”¨ã®tRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
export const trpcReact = createTRPCReact<AppRouter>();

export function TRPCProvider({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient());
  const [trpcClient] = useState(() =>
    trpcReact.createClient({
      links: [
        httpBatchLink({
          url: 'http://localhost:3001',
        }),
      ],
    })
  );

  return (
    <trpcReact.Provider client={trpcClient} queryClient={queryClient}>
      <QueryClientProvider client={queryClient}>
        {children}
      </QueryClientProvider>
    </trpcReact.Provider>
  );
}
```

## å®Ÿè·µçš„ãªä½¿ç”¨ä¾‹

### 1. åŸºæœ¬çš„ãªã‚¯ã‚¨ãƒªã¨ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// src/components/UserList.tsx
import React from 'react';
import { trpcReact } from '../client/providers';

export function UserList() {
  // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼ˆã‚¯ã‚¨ãƒªï¼‰
  const { data: users, isLoading, error } = trpcReact.user.getAll.useQuery();

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const createUser = trpcReact.user.create.useMutation({
    onSuccess: () => {
      // æˆåŠŸæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†å–å¾—
      trpcReact.user.getAll.invalidate();
    },
  });

  const handleCreateUser = () => {
    createUser.mutate({
      name: 'New User',
      email: 'newuser@example.com',
      age: 25
    });
  };

  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;

  return (
    <div>
      <h2>Users</h2>
      <button onClick={handleCreateUser} disabled={createUser.isLoading}>
        {createUser.isLoading ? 'Creating...' : 'Create User'}
      </button>

      <ul>
        {users?.map((user) => (
          <li key={user.id}>
            {user.name} ({user.email}) - {user.age} years old
          </li>
        ))}
      </ul>
    </div>
  );
}
```

### 2. æ¡ä»¶ä»˜ãã‚¯ã‚¨ãƒª

```typescript
// src/components/UserDetail.tsx
import React, { useState } from 'react';
import { trpcReact } from '../client/providers';

export function UserDetail() {
  const [userId, setUserId] = useState<string>('');

  // æ¡ä»¶ä»˜ãã‚¯ã‚¨ãƒªï¼ˆuserIdãŒç©ºã§ãªã„å ´åˆã®ã¿å®Ÿè¡Œï¼‰
  const { data: user, isLoading, error } = trpcReact.user.getById.useQuery(
    { id: userId },
    { enabled: !!userId } // userIdãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
  );

  return (
    <div>
      <input
        type="text"
        value={userId}
        onChange={(e) => setUserId(e.target.value)}
        placeholder="Enter user ID"
      />

      {userId && (
        <div>
          {isLoading && <div>Loading user...</div>}
          {error && <div>Error: {error.message}</div>}
          {user && (
            <div>
              <h3>{user.name}</h3>
              <p>Email: {user.email}</p>
              <p>Age: {user.age}</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

### 3. æ¥½è¦³çš„æ›´æ–°

```typescript
// src/components/UserUpdate.tsx
import React, { useState } from 'react';
import { trpcReact } from '../client/providers';

interface UserUpdateProps {
  userId: string;
  initialUser: { name: string; email: string; age: number };
}

export function UserUpdate({ userId, initialUser }: UserUpdateProps) {
  const [formData, setFormData] = useState(initialUser);

  const utils = trpcReact.useUtils();

  const updateUser = trpcReact.user.update.useMutation({
    // æ¥½è¦³çš„æ›´æ–°
    onMutate: async (newData) => {
      // é€²è¡Œä¸­ã®ã‚¯ã‚¨ãƒªã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      await utils.user.getAll.cancel();

      // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const previousUsers = utils.user.getAll.getData();

      // æ¥½è¦³çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      utils.user.getAll.setData(undefined, (old) =>
        old?.map((user) =>
          user.id === userId ? { ...user, ...newData } : user
        )
      );

      // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
      return { previousUsers };
    },

    // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    onError: (err, newData, context) => {
      if (context?.previousUsers) {
        utils.user.getAll.setData(undefined, context.previousUsers);
      }
    },

    // æˆåŠŸæ™‚ã®å‡¦ç†
    onSettled: () => {
      utils.user.getAll.invalidate();
    },
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    updateUser.mutate({
      id: userId,
      ...formData
    });
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="text"
        value={formData.name}
        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
        placeholder="Name"
      />
      <input
        type="email"
        value={formData.email}
        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
        placeholder="Email"
      />
      <input
        type="number"
        value={formData.age}
        onChange={(e) => setFormData({ ...formData, age: Number(e.target.value) })}
        placeholder="Age"
      />
      <button type="submit" disabled={updateUser.isLoading}>
        {updateUser.isLoading ? 'Updating...' : 'Update User'}
      </button>
    </form>
  );
}
```

## é«˜åº¦ãªæ©Ÿèƒ½

### 1. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

```typescript
// src/server/trpc.ts
import { initTRPC, TRPCError } from '@trpc/server'
import { z } from 'zod'

// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å‹å®šç¾©
interface Context {
  user?: {
    id: string
    name: string
    role: 'admin' | 'user'
  }
}

// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆé–¢æ•°
const createContext = (): Context => {
  // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  return {
    user: {
      id: '1',
      name: 'Alice',
      role: 'admin',
    },
  }
}

const t = initTRPC.context<Context>().create()

export const router = t.router
export const publicProcedure = t.procedure

// èªè¨¼ãŒå¿…è¦ãªãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£
export const protectedProcedure = t.procedure.use(({ ctx, next }) => {
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: 'You must be logged in to access this resource',
    })
  }
  return next({
    ctx: {
      ...ctx,
      user: ctx.user, // å‹å®‰å…¨æ€§ã®ãŸã‚
    },
  })
})

// ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ãªãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£
export const adminProcedure = protectedProcedure.use(({ ctx, next }) => {
  if (ctx.user.role !== 'admin') {
    throw new TRPCError({
      code: 'FORBIDDEN',
      message: 'Admin access required',
    })
  }
  return next()
})
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// src/server/routers/user.router.ts
import { TRPCError } from '@trpc/server'
import { z } from 'zod'

export const userRouter = router({
  getById: publicProcedure.input(z.object({ id: z.string() })).query(({ input }) => {
    const user = users.find((u) => u.id === input.id)

    if (!user) {
      throw new TRPCError({
        code: 'NOT_FOUND',
        message: 'User not found',
        cause: { userId: input.id },
      })
    }

    return user
  }),

  create: protectedProcedure
    .input(
      z.object({
        name: z.string().min(1, 'Name is required'),
        email: z.string().email('Invalid email format'),
        age: z.number().min(0, 'Age must be positive').max(120, 'Age must be less than 120'),
      }),
    )
    .mutation(({ input, ctx }) => {
      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
      const existingUser = users.find((u) => u.email === input.email)
      if (existingUser) {
        throw new TRPCError({
          code: 'CONFLICT',
          message: 'User with this email already exists',
        })
      }

      const newUser = {
        id: String(users.length + 1),
        ...input,
        createdAt: new Date(),
        createdBy: ctx.user.id,
      }

      users.push(newUser)
      return newUser
    }),

  delete: adminProcedure.input(z.object({ id: z.string() })).mutation(({ input }) => {
    const userIndex = users.findIndex((u) => u.id === input.id)
    if (userIndex === -1) {
      throw new TRPCError({
        code: 'NOT_FOUND',
        message: 'User not found',
      })
    }

    const deletedUser = users.splice(userIndex, 1)[0]
    return deletedUser
  }),
})
```

### 3. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰

```typescript
// src/server/routers/notification.router.ts
import { EventEmitter } from 'events'
import { z } from 'zod'

// ã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒŸãƒƒã‚¿ãƒ¼ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯Redis Pub/Subãªã©ã‚’ä½¿ç”¨ï¼‰
const ee = new EventEmitter()

export const notificationRouter = router({
  // é€šçŸ¥ã®é€ä¿¡
  send: protectedProcedure
    .input(
      z.object({
        message: z.string(),
        userId: z.string(),
      }),
    )
    .mutation(({ input }) => {
      const notification = {
        id: Date.now().toString(),
        message: input.message,
        userId: input.userId,
        timestamp: new Date(),
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      ee.emit('notification', notification)

      return notification
    }),

  // é€šçŸ¥ã®è³¼èª­
  onNotification: protectedProcedure
    .input(z.object({ userId: z.string() }))
    .subscription(({ input }) => {
      return new Observable<{ message: string; timestamp: Date }>((emit) => {
        const onNotification = (notification: any) => {
          if (notification.userId === input.userId) {
            emit.next({
              message: notification.message,
              timestamp: notification.timestamp,
            })
          }
        }

        ee.on('notification', onNotification)

        return () => {
          ee.off('notification', onNotification)
        }
      })
    }),
})
```

## Next.jsã¨ã®çµ±åˆ

### 1. API Routes

```typescript
// pages/api/trpc/[trpc].ts
import { createNextApiHandler } from '@trpc/server/adapters/next'
import { appRouter } from '../../../server/routers'
import { createContext } from '../../../server/trpc'

export default createNextApiHandler({
  router: appRouter,
  createContext,
  onError:
    process.env.NODE_ENV === 'development'
      ? ({ path, error }) => {
          console.error(`âŒ tRPC failed on ${path ?? '<no-path>'}: ${error.message}`)
        }
      : undefined,
})
```

### 2. App Routerï¼ˆNext.js 13+ï¼‰

```typescript
// app/api/trpc/[trpc]/route.ts
import { fetchRequestHandler } from '@trpc/server/adapters/fetch'
import { appRouter } from '../../../../server/routers'
import { createContext } from '../../../../server/trpc'

const handler = (req: Request) =>
  fetchRequestHandler({
    endpoint: '/api/trpc',
    req,
    router: appRouter,
    createContext,
  })

export { handler as GET, handler as POST }
```

### 3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆNext.jsï¼‰

```typescript
// src/client/trpc.ts
import { createTRPCNext } from '@trpc/next'
import { httpBatchLink } from '@trpc/client'
import type { AppRouter } from '../server/routers'

export const trpc = createTRPCNext<AppRouter>({
  config() {
    return {
      links: [
        httpBatchLink({
          url: '/api/trpc',
        }),
      ],
    }
  },
  ssr: false, // SSRã‚’ç„¡åŠ¹ã«ã™ã‚‹å ´åˆ
})
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ãƒãƒƒãƒå‡¦ç†

```typescript
// è¤‡æ•°ã®ã‚¯ã‚¨ãƒªã‚’åŒæ™‚ã«å®Ÿè¡Œ
const [users, posts, comments] = await Promise.all([
  trpc.user.getAll.query(),
  trpc.post.getAll.query(),
  trpc.comment.getAll.query(),
])
```

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```typescript
// src/components/OptimizedUserList.tsx
import React from 'react';
import { trpcReact } from '../client/providers';

export function OptimizedUserList() {
  const { data: users, isLoading } = trpcReact.user.getAll.useQuery(
    undefined,
    {
      staleTime: 5 * 60 * 1000, // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      cacheTime: 10 * 60 * 1000, // 10åˆ†é–“ãƒ¡ãƒ¢ãƒªã«ä¿æŒ
      refetchOnWindowFocus: false, // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å†å–å¾—ã‚’ç„¡åŠ¹
    }
  );

  if (isLoading) return <div>Loading...</div>;

  return (
    <div>
      <h2>Users ({users?.length})</h2>
      <ul>
        {users?.map((user) => (
          <li key={user.id}>{user.name}</li>
        ))}
      </ul>
    </div>
  );
}
```

### 3. ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

```typescript
// src/server/routers/post.router.ts
export const postRouter = router({
  getInfinite: publicProcedure
    .input(
      z.object({
        limit: z.number().min(1).max(100).default(10),
        cursor: z.string().nullish(),
      }),
    )
    .query(async ({ input }) => {
      const { limit, cursor } = input
      const items = await getPosts({
        limit: limit + 1,
        cursor,
      })

      let nextCursor: typeof cursor | undefined = undefined
      if (items.length > limit) {
        const nextItem = items.pop()
        nextCursor = nextItem?.id
      }

      return {
        items,
        nextCursor,
      }
    }),
})
```

## ã¾ã¨ã‚

tRPCã‚’ä½¿ã†ã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ©ç‚¹ãŒå¾—ã‚‰ã‚Œã¾ã™ï¼š

### ä¸»ãªåˆ©ç‚¹

1. **å‹å®‰å…¨æ€§**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–“ã§å®Œå…¨ãªå‹å®‰å…¨æ€§ã‚’å®Ÿç¾
2. **é–‹ç™ºåŠ¹ç‡**: è‡ªå‹•è£œå®Œã¨IntelliSenseã«ã‚ˆã‚‹é«˜é€Ÿé–‹ç™º
3. **ä¿å®ˆæ€§**: å‹å®šç¾©ã®å¤‰æ›´ãŒè‡ªå‹•çš„ã«å…¨ä½“ã«åæ˜ 
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒãƒƒãƒå‡¦ç†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹æœ€é©åŒ–
5. **å­¦ç¿’ã‚³ã‚¹ãƒˆ**: æ—¢å­˜ã®TypeScriptçŸ¥è­˜ã§å§‹ã‚ã‚‰ã‚Œã‚‹

### å®Ÿè·µã®ãƒã‚¤ãƒ³ãƒˆ

- **æ®µéšçš„ãªå°å…¥**: æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¾ã€…ã«å°å…¥
- **é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: Zodã‚’ä½¿ã£ãŸå…¥åŠ›æ¤œè¨¼
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã¨ãƒãƒƒãƒå‡¦ç†ã®æ´»ç”¨
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: èªè¨¼ãƒ»èªå¯ã®é©åˆ‡ãªå®Ÿè£…

[tRPCå…¬å¼ã‚µã‚¤ãƒˆ](https://trpc.io/)ã§ã¯ã€ã•ã‚‰ã«è©³ç´°ãªæƒ…å ±ã¨å®Ÿè·µçš„ãªä¾‹ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚å‹å®‰å…¨ãªAPIé–‹ç™ºã«ã‚ˆã‚Šã€é–‹ç™ºåŠ¹ç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã§ã—ã‚‡ã†ã€‚

å¾“æ¥ã®REST APIã‚„GraphQLã¨æ¯”è¼ƒã—ã¦ã€tRPCã¯TypeScriptã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã«ç‰¹åŒ–ã—ãŸå„ªã‚ŒãŸé¸æŠè‚¢ã§ã™ã€‚ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯TypeScriptã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«ãŠã„ã¦ã€tRPCã¯å¼·åŠ›ãªãƒ„ãƒ¼ãƒ«ã¨ãªã‚‹ã§ã—ã‚‡ã†ã€‚
