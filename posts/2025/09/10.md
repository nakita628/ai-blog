---
date: 2025-09-10
title: Cloud Run に GitHub Actions で Next.js をデプロイする完全ガイド
description: Google Cloud Run に GitHub Actions を使って Next.js アプリケーションを自動デプロイする方法を詳しく解説。Docker化から本番環境での設定まで、初心者でも理解できる実践的な内容で説明します。
tags:
    - nextjs
    - cloud-run
    - github-actions
    - deployment
    - docker
    - cicd
    - google-cloud
    - web-development
prev:
    text: "TypeScriptと数学で作るゲームアルゴリズム：初心者向け実践ガイド"
    link: "/posts/2025/09/09"
next: false
---

# Cloud Run に GitHub Actions で Next.js をデプロイする完全ガイド

Google Cloud Run は、コンテナ化されたアプリケーションをサーバーレスで実行できるサービスです。この記事では、GitHub Actions を使って Next.js アプリケーションを Cloud Run に自動デプロイする方法を詳しく解説します。

## 前提条件と準備

### 必要なもの

1. **Google Cloud アカウント**
2. **GitHub アカウント**
3. **Google Cloud プロジェクト**
4. **Next.js アプリケーション**

### Google Cloud の初期設定

1. [Google Cloud Console](https://console.cloud.google.com/) でプロジェクトを作成
2. 以下のAPIを有効化：
   - Cloud Run API
   - Cloud Build API
   - Container Registry API
   - Artifact Registry API

## Next.js アプリケーションの準備

### 1. 基本的な Next.js プロジェクト

```bash
# Next.js プロジェクトの作成
npx create-next-app@latest my-nextjs-app
cd my-nextjs-app

# 必要な依存関係のインストール
npm install
```

### 2. 環境変数の設定

```bash
# .env.local ファイルの作成
touch .env.local
```

```env
# .env.local
NEXT_PUBLIC_API_URL=https://api.example.com
DATABASE_URL=your-database-url
NEXTAUTH_SECRET=your-secret-key
NEXTAUTH_URL=https://your-domain.com
```

### 3. 本番用の設定

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 本番環境での最適化
  output: 'standalone', // Docker用の最適化
  experimental: {
    // サーバーサイドレンダリングの最適化
    serverComponentsExternalPackages: [],
  },
  // 環境変数の設定
  env: {
    CUSTOM_KEY: process.env.CUSTOM_KEY,
  },
  // 画像最適化の設定
  images: {
    domains: ['example.com'],
  },
  // リダイレクトの設定
  async redirects() {
    return [
      {
        source: '/old-page',
        destination: '/new-page',
        permanent: true,
      },
    ];
  },
};

module.exports = nextConfig;
```

## Docker 化の設定

### 1. Dockerfile の作成

```dockerfile
# Dockerfile
FROM node:18-alpine AS base

# 依存関係のインストール
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# パッケージファイルのコピー
COPY package.json package-lock.json* ./
RUN npm ci --only=production

# ビルドステージ
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# 環境変数の設定
ENV NEXT_TELEMETRY_DISABLED 1

# アプリケーションのビルド
RUN npm run build

# 本番用イメージ
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# 非rootユーザーの作成
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# ビルド成果物のコピー
COPY --from=builder /app/public ./public

# 自動的に最適化された出力を利用
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# アプリケーションの起動
CMD ["node", "server.js"]
```

### 2. .dockerignore の作成

```dockerignore
# .dockerignore
Dockerfile
.dockerignore
node_modules
npm-debug.log
README.md
.env
.env.local
.env.production.local
.env.development.local
.git
.gitignore
.next
.vercel
```

### 3. ローカルでの Docker テスト

```bash
# Docker イメージのビルド
docker build -t my-nextjs-app .

# ローカルで実行
docker run -p 3000:3000 my-nextjs-app
```

## Google Cloud の設定

### 1. サービスアカウントの作成

```bash
# サービスアカウントの作成
gcloud iam service-accounts create github-actions \
  --display-name="GitHub Actions Service Account" \
  --description="Service account for GitHub Actions deployment"

# 必要な権限の付与
gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
  --member="serviceAccount:github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
  --member="serviceAccount:github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser"

gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
  --member="serviceAccount:github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/storage.admin"

gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \
  --member="serviceAccount:github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.admin"
```

### 2. サービスアカウントキーの生成

```bash
# キーファイルの生成
gcloud iam service-accounts keys create key.json \
  --iam-account=github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com
```

### 3. Artifact Registry の設定

```bash
# Artifact Registry リポジトリの作成
gcloud artifacts repositories create my-repo \
  --repository-format=docker \
  --location=asia-northeast1 \
  --description="Docker repository for Next.js app"
```

## GitHub Actions の設定

### 1. 基本的なワークフロー

```yaml
# .github/workflows/deploy.yml
name: Deploy to Cloud Run

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: nextjs-app
  REGION: asia-northeast1
  REPOSITORY: my-repo

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Run linting
      run: npm run lint
      
    - name: Build application
      run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        
    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      
    - name: Build and push Docker image
      run: |
        docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 3000 \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --set-env-vars NODE_ENV=production
```

### 2. 環境変数を含む高度なワークフロー

```yaml
# .github/workflows/deploy-advanced.yml
name: Advanced Deploy to Cloud Run

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  REPOSITORY: my-repo

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        
    - name: Set environment variables
      id: env
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        else
          echo "environment=production" >> $GITHUB_OUTPUT
        fi
        
        if [[ "${{ steps.env.outputs.environment }}" == "staging" ]]; then
          echo "service_name=nextjs-app-staging" >> $GITHUB_OUTPUT
          echo "memory=512Mi" >> $GITHUB_OUTPUT
          echo "min_instances=0" >> $GITHUB_OUTPUT
        else
          echo "service_name=nextjs-app" >> $GITHUB_OUTPUT
          echo "memory=1Gi" >> $GITHUB_OUTPUT
          echo "min_instances=1" >> $GITHUB_OUTPUT
        fi
        
    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      
    - name: Build and push Docker image
      run: |
        docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ steps.env.outputs.service_name }}:${{ github.sha }} .
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ steps.env.outputs.service_name }}:${{ github.sha }}
        
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ steps.env.outputs.service_name }} \
          --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ steps.env.outputs.service_name }}:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 3000 \
          --memory ${{ steps.env.outputs.memory }} \
          --cpu 1 \
          --min-instances ${{ steps.env.outputs.min_instances }} \
          --max-instances 10 \
          --set-env-vars NODE_ENV=${{ steps.env.outputs.environment }} \
          --set-env-vars NEXT_PUBLIC_API_URL=${{ secrets.API_URL }} \
          --set-secrets DATABASE_URL=database-url:latest \
          --set-secrets NEXTAUTH_SECRET=nextauth-secret:latest
          
    - name: Get service URL
      id: url
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ steps.env.outputs.service_name }} --region=${{ env.REGION }} --format="value(status.url)")
        echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
        
    - name: Comment deployment URL
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `🚀 Deployment successful! 
            
            **Environment:** ${{ steps.env.outputs.environment }}
            **Service:** ${{ steps.env.outputs.service_name }}
            **URL:** ${{ steps.url.outputs.service_url }}
            **Commit:** ${{ github.sha }}`
          })
```

## GitHub Secrets の設定

GitHub リポジトリの **Settings** → **Secrets and variables** → **Actions** で以下を設定：

### 必須の Secrets

- `GCP_PROJECT_ID`: Google Cloud プロジェクトID
- `GCP_SA_KEY`: サービスアカウントキーのJSON（Base64エンコード）

### オプションの Secrets

- `API_URL`: API のベースURL
- `DATABASE_URL`: データベース接続文字列
- `NEXTAUTH_SECRET`: NextAuth.js のシークレット

### サービスアカウントキーの Base64 エンコード

```bash
# キーファイルを Base64 エンコード
base64 -i key.json | tr -d '\n'
```

## 本番環境での設定

### 1. カスタムドメインの設定

```bash
# カスタムドメインのマッピング
gcloud run domain-mappings create \
  --service nextjs-app \
  --domain your-domain.com \
  --region asia-northeast1
```

### 2. SSL 証明書の設定

```bash
# マネージドSSL証明書の作成
gcloud compute ssl-certificates create nextjs-ssl-cert \
  --domains your-domain.com,www.your-domain.com \
  --global
```

### 3. ロードバランサーの設定

```yaml
# load-balancer.yaml
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: nextjs-ssl-cert
spec:
  domains:
    - your-domain.com
    - www.your-domain.com
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nextjs-ingress
  annotations:
    kubernetes.io/ingress.global-static-ip-name: nextjs-ip
    networking.gke.io/managed-certificates: nextjs-ssl-cert
    kubernetes.io/ingress.class: "gce"
spec:
  rules:
  - host: your-domain.com
    http:
      paths:
      - path: /*
        pathType: ImplementationSpecific
        backend:
          service:
            name: nextjs-app
            port:
              number: 80
```

## 監視とログ

### 1. ログの確認

```bash
# Cloud Run サービスのログを確認
gcloud logs read "resource.type=cloud_run_revision AND resource.labels.service_name=nextjs-app" --limit=50

# リアルタイムログの監視
gcloud logs tail "resource.type=cloud_run_revision AND resource.labels.service_name=nextjs-app"
```

### 2. メトリクスの監視

```bash
# サービスの詳細情報
gcloud run services describe nextjs-app --region=asia-northeast1

# メトリクスの確認
gcloud monitoring metrics list --filter="resource.type=cloud_run_revision"
```

### 3. アラートの設定

```yaml
# alert-policy.yaml
displayName: "Cloud Run High Error Rate"
conditions:
  - displayName: "Error rate is high"
    conditionThreshold:
      filter: 'resource.type="cloud_run_revision" metric.type="run.googleapis.com/request_count"'
      comparison: COMPARISON_GREATER_THAN
      thresholdValue: 0.1
      duration: 300s
notificationChannels:
  - projects/YOUR_PROJECT_ID/notificationChannels/YOUR_CHANNEL_ID
```

## パフォーマンス最適化

### 1. Next.js の最適化設定

```javascript
// next.config.js
const nextConfig = {
  // 画像最適化
  images: {
    formats: ['image/webp', 'image/avif'],
    minimumCacheTTL: 60,
  },
  
  // 圧縮の有効化
  compress: true,
  
  // 静的ファイルの最適化
  assetPrefix: process.env.NODE_ENV === 'production' ? 'https://cdn.example.com' : '',
  
  // バンドル分析
  webpack: (config, { isServer }) => {
    if (!isServer) {
      config.resolve.fallback = {
        ...config.resolve.fallback,
        fs: false,
      };
    }
    return config;
  },
};
```

### 2. Cloud Run の最適化

```bash
# 最適化されたデプロイ設定
gcloud run deploy nextjs-app \
  --image gcr.io/YOUR_PROJECT_ID/nextjs-app:latest \
  --platform managed \
  --region asia-northeast1 \
  --memory 2Gi \
  --cpu 2 \
  --concurrency 80 \
  --min-instances 1 \
  --max-instances 100 \
  --timeout 300 \
  --set-env-vars NODE_ENV=production
```

## トラブルシューティング

### よくある問題と解決方法

#### 1. ビルドエラー

```bash
# ローカルでビルドテスト
npm run build

# Docker ビルドの詳細ログ
docker build --no-cache -t test-image .
```

#### 2. デプロイエラー

```bash
# サービスの状態確認
gcloud run services describe nextjs-app --region=asia-northeast1

# ログの確認
gcloud logs read "resource.type=cloud_run_revision" --limit=100
```

#### 3. 環境変数の問題

```bash
# 環境変数の確認
gcloud run services describe nextjs-app --region=asia-northeast1 --format="value(spec.template.spec.template.spec.containers[0].env[].name,spec.template.spec.template.spec.containers[0].env[].value)"
```

## まとめ

Cloud Run に GitHub Actions で Next.js をデプロイする方法を解説しました：

### 主な手順

1. **Next.js アプリケーションの準備**: Docker化と最適化設定
2. **Google Cloud の設定**: サービスアカウントと Artifact Registry
3. **GitHub Actions の設定**: 自動ビルドとデプロイのワークフロー
4. **本番環境の設定**: カスタムドメインとSSL証明書
5. **監視とログ**: 運用状況の把握

### 利点

- **自動化**: コードの変更が自動的に本番環境に反映
- **スケーラビリティ**: トラフィックに応じた自動スケーリング
- **コスト効率**: 使用量に応じた料金体系
- **セキュリティ**: 適切な権限管理とシークレット管理

### 実践のポイント

- **段階的な導入**: まずは簡単なアプリケーションから始める
- **テストの充実**: デプロイ前の自動テスト
- **監視の設定**: ログとメトリクスによる運用状況の把握
- **セキュリティ**: 適切な権限設定とシークレット管理

この方法により、効率的で安全な Next.js アプリケーションのデプロイが実現できます。
