---
date: 2025-08-27
title: Auth.js (NextAuth v5) å®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼šPrismaé€£æºã¨JWTã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸¡æ–¹ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
description: Auth.js (NextAuth v5) ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’åˆå¿ƒè€…å‘ã‘ã«å¾¹åº•è§£èª¬ã€‚Prismaã‚¢ãƒ€ãƒ—ã‚¿ã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨JWTã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®ä¸¡æ–¹ã®å®Ÿè£…ä¾‹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã€OAuthèªè¨¼ã¾ã§ç¶²ç¾…ã€‚
tags:
  - auth-js
  - nextauth
  - next-js
  - prisma
  - authentication
  - jwt
  - oauth
  - typescript
prev:
  text: 'Cloud Runå®Œå…¨å…¥é–€ï¼šåˆå¿ƒè€…ã§ã‚‚ã‚ã‹ã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ—ãƒªé–‹ç™ºã®å§‹ã‚æ–¹'
  link: '/posts/2025/08/26'
next: false
---

# Auth.js (NextAuth v5) å®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼šPrismaé€£æºã¨JWTã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸¡æ–¹ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

Auth.jsï¼ˆæ—§NextAuth.jsï¼‰ã¯ã€Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«èªè¨¼æ©Ÿèƒ½ã‚’ç°¡å˜ã«è¿½åŠ ã§ãã‚‹å¼·åŠ›ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã ã€‚v5ã§ã¯å¤§å¹…ãªæ”¹è‰¯ãŒè¡Œã‚ã‚Œã€ã‚ˆã‚ŠæŸ”è»Ÿã§å®‰å…¨ãªèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚æœ¬è¨˜äº‹ã§ã¯ã€åˆå¿ƒè€…ã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ãAuth.jsã®åŸºæœ¬æ¦‚å¿µã‹ã‚‰å®Ÿè£…ã¾ã§ã€Prismaé€£æºã¨JWTã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸¡æ–¹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©³ã—ãè§£èª¬ã™ã‚‹ã€‚

## Auth.js v5ã®åŸºæœ¬æ¦‚å¿µã¨å¤‰æ›´ç‚¹

### NextAuth v4ã‹ã‚‰ã®ä¸»ãªå¤‰æ›´ç‚¹

Auth.js v5ï¼ˆNextAuth v5ï¼‰ã§ã¯ã€ä»¥ä¸‹ã®é‡è¦ãªå¤‰æ›´ãŒè¡Œã‚ã‚ŒãŸï¼š

```mermaid
graph TB
    subgraph "v4 (æ—§ç‰ˆ)"
        A["pages/api/auth/[...nextauth].js"]
        B["getServerSession"]
        C["NEXTAUTH_* ç’°å¢ƒå¤‰æ•°"]
        D["withAuth ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢"]
    end

    subgraph "v5 (æ–°ç‰ˆ)"
        E["auth.ts è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«"]
        F["auth() çµ±ä¸€é–¢æ•°"]
        G["AUTH_* ç’°å¢ƒå¤‰æ•°"]
        H["export { auth as middleware }"]
    end

    A --> E
    B --> F
    C --> G
    D --> H

    style E fill:#c8e6c9
    style F fill:#c8e6c9
    style G fill:#c8e6c9
    style H fill:#c8e6c9
```

**ä¸»ãªæ”¹å–„ç‚¹**ï¼š

- **è¨­å®šã®ä¸€å…ƒåŒ–**: ã™ã¹ã¦ã®è¨­å®šã‚’ `auth.ts` ã«é›†ç´„
- **API ã®çµ±ä¸€**: `auth()` é–¢æ•°ã§ã™ã¹ã¦ã®èªè¨¼å‡¦ç†ã‚’çµ±ä¸€
- **ç’°å¢ƒå¤‰æ•°ã®çµ±ä¸€**: `AUTH_*` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«çµ±ä¸€
- **TypeScript ã‚µãƒãƒ¼ãƒˆå¼·åŒ–**: å‹å®‰å…¨æ€§ã®å‘ä¸Š
- **App Router å®Œå…¨å¯¾å¿œ**: Next.js 14+ ã® App Router ã«æœ€é©åŒ–

### åŸºæœ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

Auth.js v5ã®æ¨™æº–çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

```
project/
â”œâ”€â”€ auth.ts                           # èªè¨¼è¨­å®šï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
â”œâ”€â”€ middleware.ts                      # ãƒ«ãƒ¼ãƒˆä¿è­·
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ auth/
â”‚           â””â”€â”€ [...nextauth]/
â”‚               â””â”€â”€ route.ts           # API ãƒ«ãƒ¼ãƒˆ
â””â”€â”€ types/
    â””â”€â”€ next-auth.d.ts                # å‹å®šç¾©æ‹¡å¼µ
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®é¸æŠ

Auth.js v5ã§ã¯2ã¤ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥ã‹ã‚‰é¸æŠã§ãã‚‹ï¼š

#### 1. Database Strategyï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æˆ¦ç•¥ï¼‰

- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
- ã‚ˆã‚Šå®‰å…¨ã ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦
- Prismaã€Drizzleç­‰ã®ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ä½¿ç”¨

#### 2. JWT Strategyï¼ˆJWTæˆ¦ç•¥ï¼‰

- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’JWTãƒˆãƒ¼ã‚¯ãƒ³ã«ä¿å­˜
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸è¦ã§é«˜é€Ÿ
- é©åˆ‡ãªå®Ÿè£…ãŒå¿…è¦

```mermaid
graph LR
    subgraph "Database Strategy"
        A["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³"] --> B["ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’DBã«ä¿å­˜"]
        B --> C["ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜"]
        C --> D["ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«DBã‹ã‚‰èª­ã¿å–ã‚Š"]
    end

    subgraph "JWT Strategy"
        E["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³"] --> F["JWT ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ"]
        F --> G["JWTã‚’ã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜"]
        G --> H["ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«JWTæ¤œè¨¼"]
    end

    style B fill:#e3f2fd
    style D fill:#e3f2fd
    style F fill:#fff3e0
    style H fill:#fff3e0
```

## Prismaã‚¢ãƒ€ãƒ—ã‚¿ã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

Database Strategyã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€Prismaã‚¢ãƒ€ãƒ—ã‚¿ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’è¡Œã†æ–¹æ³•ã‚’è©³ã—ãè¦‹ã¦ã¿ã‚ˆã†ã€‚

### å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
npm install next-auth@beta @auth/prisma-adapter prisma @prisma/client

# é–‹ç™ºç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
npm install -D prisma
```

### Prismaã‚¹ã‚­ãƒ¼ãƒã®è¨­å®š

Auth.jsç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚ä»¥ä¸‹ã¯å¿…è¦æœ€å°é™ã®ã‚¹ã‚­ãƒ¼ãƒï¼š

```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // ã¾ãŸã¯ "mysql", "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          String    @default("user") // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¾‹
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts Account[]
  sessions Session[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}
```

### Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®š

```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### Auth.jsè¨­å®šï¼ˆPrismaã‚¢ãƒ€ãƒ—ã‚¿ä½¿ç”¨ï¼‰

```typescript
// auth.ts
import NextAuth, { type NextAuthConfig } from 'next-auth'
import { PrismaAdapter } from '@auth/prisma-adapter'
import { prisma } from '@/lib/prisma'
import Google from 'next-auth/providers/google'
import GitHub from 'next-auth/providers/github'

export const authConfig = {
  // æœ¬ç•ªç’°å¢ƒã§ã¯å¿…é ˆ
  trustHost: true,

  // Prismaã‚¢ãƒ€ãƒ—ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æˆ¦ç•¥ã‚’æœ‰åŠ¹åŒ–
  adapter: PrismaAdapter(prisma),
  session: { strategy: 'database' },

  providers: [
    Google({
      clientId: process.env.AUTH_GOOGLE_ID,
      clientSecret: process.env.AUTH_GOOGLE_SECRET,
    }),
    GitHub({
      clientId: process.env.AUTH_GITHUB_ID,
      clientSecret: process.env.AUTH_GITHUB_SECRET,
    }),
  ],

  callbacks: {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
    session({ session, user }) {
      if (session.user) {
        session.user.id = user.id
        session.user.role = (user as any).role
      }
      return session
    },

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã®å‡¦ç†
    async signIn({ user, account, profile }) {
      // å¿…è¦ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
      return true
    },
  },

  // ã‚«ã‚¹ã‚¿ãƒ ãƒšãƒ¼ã‚¸ã®è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  pages: {
    signIn: '/auth/signin',
    error: '/auth/error',
  },
} satisfies NextAuthConfig

export const { auth, handlers, signIn, signOut } = NextAuth(authConfig)
```

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```env
# .env.local
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
DATABASE_URL="postgresql://username:password@localhost:5432/myapp"

# Auth.jsè¨­å®š
AUTH_SECRET="your-secret-key-here" # npx auth secret ã§ç”Ÿæˆ
AUTH_TRUST_HOST=true

# OAuth ãƒ—ãƒ­ãƒã‚¤ãƒ€è¨­å®š
AUTH_GOOGLE_ID="your-google-client-id"
AUTH_GOOGLE_SECRET="your-google-client-secret"
AUTH_GITHUB_ID="your-github-client-id"
AUTH_GITHUB_SECRET="your-github-client-secret"
```

### APIãƒ«ãƒ¼ãƒˆã®è¨­å®š

```typescript
// app/api/auth/[...nextauth]/route.ts
import { handlers } from '@/auth'

export const { GET, POST } = handlers
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒˆä¿è­·

```typescript
// middleware.ts
export { auth as middleware } from '@/auth'

export const config = {
  // ä¿è­·ã—ãŸã„ãƒ«ãƒ¼ãƒˆã‚’æŒ‡å®š
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}
```

### ä½¿ç”¨ä¾‹ï¼šServer Componentã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯

```typescript
// app/dashboard/page.tsx
import { auth } from "@/auth"
import { redirect } from "next/navigation"

export default async function Dashboard() {
  const session = await auth()

  if (!session) {
    redirect("/auth/signin")
  }

  return (
    <div>
      <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p>ã“ã‚“ã«ã¡ã¯ã€{session.user?.name}ã•ã‚“</p>
      <p>ã‚ãªãŸã®å½¹å‰²: {session.user?.role}</p>
    </div>
  )
}
```

### ä½¿ç”¨ä¾‹ï¼šClient Componentã§ã®èªè¨¼ãƒã‚§ãƒƒã‚¯

```typescript
// app/profile/page.tsx
"use client"

import { useSession } from "next-auth/react"
import { SessionProvider } from "next-auth/react"

function ProfileContent() {
  const { data: session, status } = useSession()

  if (status === "loading") return <p>èª­ã¿è¾¼ã¿ä¸­...</p>
  if (status === "unauthenticated") return <p>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>

  return (
    <div>
      <h1>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
      <p>åå‰: {session?.user?.name}</p>
      <p>ãƒ¡ãƒ¼ãƒ«: {session?.user?.email}</p>
    </div>
  )
}

export default function Profile() {
  return (
    <SessionProvider>
      <ProfileContent />
    </SessionProvider>
  )
}
```

### Prisma Studio ã§ãƒ‡ãƒ¼ã‚¿ç¢ºèª

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npx prisma migrate dev --name init

# Prisma Studioèµ·å‹•ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å†…å®¹ã‚’è¦–è¦šçš„ã«ç¢ºèªï¼‰
npx prisma studio
```

## JWTã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®å®Ÿè£…

JWTï¼ˆJSON Web Tokenï¼‰æˆ¦ç•¥ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã‚ãšã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«ä¿å­˜ã™ã‚‹æ–¹æ³•ã ã€‚é«˜é€Ÿã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã ãŒã€é©åˆ‡ãªå®Ÿè£…ãŒå¿…è¦ã«ãªã‚‹ã€‚

### JWTã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

#### ãƒ¡ãƒªãƒƒãƒˆ

- **é«˜é€Ÿ**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ä¸è¦
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«**: ã‚µãƒ¼ãƒãƒ¼é–“ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å…±æœ‰ãŒå®¹æ˜“
- **è»½é‡**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸è¦ã§é‹ç”¨ãŒç°¡å˜
- **ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹**: ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿æŒã—ãªã„

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯**: ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ¼æ´©ã™ã‚‹ã¨å±é™º
- **ã‚µã‚¤ã‚ºåˆ¶é™**: ã‚¯ãƒƒã‚­ãƒ¼ã‚µã‚¤ã‚ºã®åˆ¶é™ï¼ˆé€šå¸¸4KBï¼‰
- **å³åº§ã®ç„¡åŠ¹åŒ–å›°é›£**: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®å³åº§ç„¡åŠ¹åŒ–ãŒé›£ã—ã„
- **æƒ…å ±æ›´æ–°ã®é…å»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å¤‰æ›´ã®åæ˜ ã«æ™‚é–“ãŒã‹ã‹ã‚‹

```mermaid
graph TB
    subgraph "JWT Strategy ã®æµã‚Œ"
        A["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³"] --> B["JWTç”Ÿæˆ"]
        B --> C["JWTã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã¿"]
        C --> D["æš—å·åŒ–ã—ã¦ã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜"]
        D --> E["ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«JWTæ¤œè¨¼"]
        E --> F["ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—"]
    end

    subgraph "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ç‚¹"
        G["é©åˆ‡ãªæœ‰åŠ¹æœŸé™è¨­å®š"]
        H["å¼·åŠ›ãªæš—å·åŒ–"]
        I["æ©Ÿå¯†æƒ…å ±ã®é™¤å¤–"]
        J["å®šæœŸçš„ãªãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°"]
    end

    style G fill:#ffebee
    style H fill:#ffebee
    style I fill:#ffebee
    style J fill:#ffebee
```

### JWTæˆ¦ç•¥ã®Auth.jsè¨­å®š

```typescript
// auth.ts (JWTæˆ¦ç•¥ç‰ˆ)
import NextAuth, { type NextAuthConfig } from 'next-auth'
import Google from 'next-auth/providers/google'
import GitHub from 'next-auth/providers/github'
import Credentials from 'next-auth/providers/credentials'
import bcrypt from 'bcryptjs'

export const authConfig = {
  trustHost: true,

  // JWTæˆ¦ç•¥ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30æ—¥
  },

  providers: [
    Google,
    GitHub,
    Credentials({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null
        }

        // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        const user = await getUserFromDatabase(credentials.email as string)

        if (!user) {
          return null
        }

        const isPasswordValid = await bcrypt.compare(
          credentials.password as string,
          user.hashedPassword,
        )

        if (!isPasswordValid) {
          return null
        }

        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role,
        }
      },
    }),
  ],

  callbacks: {
    // JWTã«ã‚«ã‚¹ã‚¿ãƒ æƒ…å ±ã‚’è¿½åŠ 
    jwt({ token, user, trigger, session }) {
      // åˆå›ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’JWTã«è¿½åŠ 
      if (user) {
        token.id = user.id
        token.role = (user as any).role
      }

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°æ™‚ã®å‡¦ç†
      if (trigger === 'update' && session) {
        token.name = session.user.name
        token.email = session.user.email
      }

      return token
    },

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
    session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string
        session.user.role = token.role as string
      }
      return session
    },
  },

  // JWTè¨­å®š
  jwt: {
    // JWT ã®æœ‰åŠ¹æœŸé™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30æ—¥ï¼‰
    maxAge: 30 * 24 * 60 * 60,
  },
} satisfies NextAuthConfig

export const { auth, handlers, signIn, signOut } = NextAuth(authConfig)

// ãƒ€ãƒŸãƒ¼é–¢æ•°ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã†ï¼‰
async function getUserFromDatabase(email: string) {
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹å®Ÿè£…
  // ä¾‹: Prismaã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
  // return await prisma.user.findUnique({ where: { email } })
  return null
}
```

### TypeScriptå‹å®šç¾©ã®æ‹¡å¼µ

```typescript
// types/next-auth.d.ts
import { DefaultSession } from 'next-auth'
import 'next-auth'
import '@auth/core/jwt'

declare module 'next-auth' {
  interface Session {
    user: {
      id: string
      role: string
    } & DefaultSession['user']
  }

  interface User {
    role: string
  }
}

declare module '@auth/core/jwt' {
  interface JWT {
    id: string
    role: string
  }
}
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã®å®Ÿè£…

JWTæˆ¦ç•¥ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ›´æ–°æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼š

```typescript
// app/profile/update/page.tsx
"use client"

import { useSession } from "next-auth/react"
import { useState } from "react"

export default function UpdateProfile() {
  const { data: session, update } = useSession()
  const [name, setName] = useState(session?.user?.name || "")

  const handleUpdate = async () => {
    // ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
    const response = await fetch("/api/user/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name }),
    })

    if (response.ok) {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆJWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†ç”Ÿæˆï¼‰
      await update({
        user: {
          ...session?.user,
          name: name,
        },
      })
    }
  }

  return (
    <div>
      <h1>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°</h1>
      <input
        type="text"
        value={name}
        onChange={(e) => setName(e.target.value)}
        placeholder="åå‰"
      />
      <button onClick={handleUpdate}>æ›´æ–°</button>
    </div>
  )
}
```

### JWTæˆ¦ç•¥ã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

```typescript
// auth.ts (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆ)
import NextAuth, { type NextAuthConfig } from 'next-auth'

export const authConfig = {
  session: {
    strategy: 'jwt',
    maxAge: 24 * 60 * 60, // 24æ™‚é–“ï¼ˆçŸ­ã‚ã«è¨­å®šï¼‰
  },

  callbacks: {
    jwt({ token, user }) {
      if (user) {
        token.id = user.id
        token.role = (user as any).role
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€æ©Ÿå¯†æƒ…å ±ã¯å«ã‚ãªã„
        // token.password = user.password // âŒ çµ¶å¯¾ã«ã—ãªã„
      }

      // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
      const now = Math.floor(Date.now() / 1000)
      if (token.exp && token.exp < now) {
        return null // æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–
      }

      return token
    },

    session({ session, token }) {
      if (session.user && token) {
        session.user.id = token.id as string
        session.user.role = token.role as string
      }
      return session
    },
  },

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  jwt: {
    maxAge: 24 * 60 * 60, // 24æ™‚é–“
    // ã‚«ã‚¹ã‚¿ãƒ æš—å·åŒ–è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    encode: async ({ token, secret }) => {
      // ã‚«ã‚¹ã‚¿ãƒ æš—å·åŒ–ãƒ­ã‚¸ãƒƒã‚¯
      return defaultEncode({ token, secret })
    },
    decode: async ({ token, secret }) => {
      // ã‚«ã‚¹ã‚¿ãƒ å¾©å·åŒ–ãƒ­ã‚¸ãƒƒã‚¯
      return defaultDecode({ token, secret })
    },
  },
} satisfies NextAuthConfig
```

### JWT vs Database Strategy æ¯”è¼ƒè¡¨

| é …ç›®                 | JWT Strategy   | Database Strategy  |
| -------------------- | -------------- | ------------------ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**   | é«˜é€Ÿï¼ˆDBä¸è¦ï¼‰ | ã‚„ã‚„ä½é€Ÿï¼ˆDBå¿…è¦ï¼‰ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | å„ªç§€           | æ™®é€š               |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**     | æ³¨æ„ãŒå¿…è¦     | é«˜ã„               |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–** | å›°é›£           | ç°¡å˜               |
| **æƒ…å ±æ›´æ–°**         | è¤‡é›‘           | ç°¡å˜               |
| **ã‚µãƒ¼ãƒãƒ¼è² è·**     | ä½ã„           | é«˜ã„               |
| **å®Ÿè£…è¤‡é›‘ã•**       | ä¸­ç¨‹åº¦         | ç°¡å˜               |
| **é©ç”¨å ´é¢**         | é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ | ä¸€èˆ¬çš„ãªã‚¢ãƒ—ãƒª     |

### ã©ã¡ã‚‰ã‚’é¸ã¶ã¹ãã‹ï¼Ÿ

#### JWTæˆ¦ç•¥ã‚’é¸ã¶ã¹ãå ´åˆ

- **é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯**ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- **ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·ã‚’æŠ‘ãˆãŸã„**å ´åˆ
- **ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹**ãªè¨­è¨ˆãŒå¿…è¦

#### Databaseæˆ¦ç•¥ã‚’é¸ã¶ã¹ãå ´åˆ

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒæœ€é‡è¦**
- **å³åº§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–**ãŒå¿…è¦
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®é »ç¹ãªæ›´æ–°**ãŒã‚ã‚‹
- **ä¸€èˆ¬çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

Auth.jsã‚’æœ¬ç•ªç’°å¢ƒã§å®‰å…¨ã«é‹ç”¨ã™ã‚‹ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’è§£èª¬ã™ã‚‹ã€‚

### ç’°å¢ƒå¤‰æ•°ã®é©åˆ‡ãªè¨­å®š

#### å¿…é ˆç’°å¢ƒå¤‰æ•°

```env
# .env.local
# ğŸ” èªè¨¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆå¿…é ˆï¼‰
AUTH_SECRET="your-super-secret-key-here"  # npx auth secret ã§ç”Ÿæˆ

# ğŸŒ ãƒ›ã‚¹ãƒˆè¨­å®š
AUTH_TRUST_HOST=true  # æœ¬ç•ªç’°å¢ƒã§ã¯å¿…é ˆ

# ğŸ”— ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒç­‰ã§å¿…è¦ï¼‰
AUTH_REDIRECT_PROXY_URL="https://your-app.vercel.app"

# ğŸ“§ OAuth ãƒ—ãƒ­ãƒã‚¤ãƒ€è¨­å®š
AUTH_GOOGLE_ID="your-google-client-id"
AUTH_GOOGLE_SECRET="your-google-client-secret"
AUTH_GITHUB_ID="your-github-client-id"
AUTH_GITHUB_SECRET="your-github-client-secret"

# ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆDatabaseæˆ¦ç•¥ä½¿ç”¨æ™‚ï¼‰
DATABASE_URL="postgresql://user:password@localhost:5432/myapp"
```

#### ç’°å¢ƒå¤‰æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `AUTH_SECRET`ã¯ååˆ†ã«é•·ã„ï¼ˆæœ€ä½32æ–‡å­—ï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒã§ã¯`AUTH_TRUST_HOST=true`ã‚’è¨­å®š
- [ ] OAuth ã®Client Secretã¯Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„
- [ ] ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹`AUTH_SECRET`ã‚’ä½¿ç”¨
- [ ] `.env.local`ã‚’`.gitignore`ã«è¿½åŠ 

### OAuth ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

#### Google OAuth ã®å®‰å…¨ãªè¨­å®š

```typescript
// auth.ts
import Google from 'next-auth/providers/google'

export const authConfig = {
  providers: [
    Google({
      clientId: process.env.AUTH_GOOGLE_ID,
      clientSecret: process.env.AUTH_GOOGLE_SECRET,
      authorization: {
        params: {
          // å¿…è¦æœ€å°é™ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®ã¿è¦æ±‚
          scope: 'openid email profile',
          // ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æ”»æ’ƒã‚’é˜²ããŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          prompt: 'consent',
          access_type: 'offline',
          response_type: 'code',
        },
      },
    }),
  ],

  callbacks: {
    // OAuth ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚ã®æ¤œè¨¼
    async signIn({ user, account, profile }) {
      // ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã®ä¾‹
      const allowedDomains = ['yourdomain.com', 'partner.com']
      const email = user.email

      if (email && allowedDomains.length > 0) {
        const domain = email.split('@')[1]
        if (!allowedDomains.includes(domain)) {
          return false // ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’æ‹’å¦
        }
      }

      // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
      return true
    },
  },
}
```

#### GitHub OAuth ã®è¨­å®š

```typescript
import GitHub from 'next-auth/providers/github'

GitHub({
  clientId: process.env.AUTH_GITHUB_ID,
  clientSecret: process.env.AUTH_GITHUB_SECRET,
  authorization: {
    params: {
      // å¿…è¦æœ€å°é™ã®ã‚¹ã‚³ãƒ¼ãƒ—
      scope: 'read:user user:email',
    },
  },
})
```

### Credentialsèªè¨¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

```typescript
// auth.ts
import Credentials from 'next-auth/providers/credentials'
import bcrypt from 'bcryptjs'
import { rateLimit } from '@/lib/rate-limit'

export const authConfig = {
  providers: [
    Credentials({
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials, req) {
        if (!credentials?.email || !credentials?.password) {
          return null
        }

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
        const clientIP = req.headers?.['x-forwarded-for'] || 'unknown'
        const rateLimitResult = await rateLimit(clientIP as string)

        if (!rateLimitResult.success) {
          throw new Error('Too many attempts. Please try again later.')
        }

        try {
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
          const user = await getUserByEmail(credentials.email)

          if (!user) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            // ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã‚’é˜²ããŸã‚
            await bcrypt.compare('dummy', '$2a$10$dummy.hash.to.prevent.timing.attacks')
            return null
          }

          // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          if (user.lockedUntil && user.lockedUntil > new Date()) {
            throw new Error('Account is temporarily locked')
          }

          // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
          const isPasswordValid = await bcrypt.compare(credentials.password, user.hashedPassword)

          if (!isPasswordValid) {
            // å¤±æ•—å›æ•°ã‚’å¢—ã‚„ã™
            await incrementFailedAttempts(user.id)
            return null
          }

          // æˆåŠŸæ™‚ã¯å¤±æ•—å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
          await resetFailedAttempts(user.id)

          return {
            id: user.id,
            email: user.email,
            name: user.name,
            role: user.role,
          }
        } catch (error) {
          console.error('Authentication error:', error)
          return null
        }
      },
    }),
  ],
}

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…ä¾‹
async function rateLimit(identifier: string) {
  // Redis ã‚„ ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…
  // ä¾‹: 5åˆ†é–“ã«5å›ã¾ã§
  return { success: true } // ç°¡ç•¥åŒ–
}

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯æ©Ÿèƒ½
async function incrementFailedAttempts(userId: string) {
  // å¤±æ•—å›æ•°ã‚’å¢—ã‚„ã—ã€5å›ã§30åˆ†ãƒ­ãƒƒã‚¯
}

async function resetFailedAttempts(userId: string) {
  // å¤±æ•—å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
}
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é©åˆ‡ãªè¨­å®š

```typescript
// auth.ts
export const authConfig = {
  session: {
    strategy: 'jwt', // ã¾ãŸã¯ "database"
    maxAge: 24 * 60 * 60, // 24æ™‚é–“ï¼ˆçŸ­ã‚ã«è¨­å®šï¼‰
    updateAge: 60 * 60, // 1æ™‚é–“ã”ã¨ã«æ›´æ–°
  },

  cookies: {
    sessionToken: {
      name: '__Secure-next-auth.session-token',
      options: {
        httpOnly: true,
        sameSite: 'lax',
        path: '/',
        secure: process.env.NODE_ENV === 'production', // HTTPSå¿…é ˆ
      },
    },
  },

  callbacks: {
    jwt({ token, user }) {
      // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      const currentIP = token.ip
      const requestIP = req?.ip

      if (currentIP && requestIP && currentIP !== requestIP) {
        // IPãŒå¤‰ã‚ã£ãŸå ´åˆã®å‡¦ç†
        console.warn('IP address changed for user:', token.sub)
      }

      if (user) {
        token.ip = requestIP
      }

      return token
    },
  },
}
```

### CSRFæ”»æ’ƒã®é˜²æ­¢

Auth.js v5ã§ã¯è‡ªå‹•çš„ã«CSRFä¿è­·ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŒã€è¿½åŠ ã®è¨­å®šã‚‚å¯èƒ½ï¼š

```typescript
// auth.ts
export const authConfig = {
  // CSRFä¿è­·ã‚’å¼·åŒ–
  useSecureCookies: process.env.NODE_ENV === 'production',

  callbacks: {
    // ã‚«ã‚¹ã‚¿ãƒ CSRFæ¤œè¨¼
    async redirect({ url, baseUrl }) {
      // åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®ã¿è¨±å¯
      if (url.startsWith('/')) return `${baseUrl}${url}`
      if (new URL(url).origin === baseUrl) return url
      return baseUrl
    },
  },
}
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã®è¿½åŠ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

```typescript
// middleware.ts
import { auth } from '@/auth'
import { NextResponse } from 'next/server'

export default auth((req) => {
  const { nextUrl, auth } = req

  // ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã®ä¿è­·
  if (nextUrl.pathname.startsWith('/admin')) {
    if (!auth?.user || auth.user.role !== 'admin') {
      return NextResponse.redirect(new URL('/unauthorized', nextUrl))
    }
  }

  // API ãƒ«ãƒ¼ãƒˆã®ä¿è­·
  if (nextUrl.pathname.startsWith('/api/protected')) {
    if (!auth) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }
  }

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 
  const response = NextResponse.next()
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')

  return response
})

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
}
```

### ç›£æŸ»ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```typescript
// lib/audit-log.ts
interface AuditEvent {
  userId?: string
  action: string
  resource: string
  ip: string
  userAgent: string
  timestamp: Date
}

export async function logAuditEvent(event: AuditEvent) {
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«è¨˜éŒ²
  console.log('Audit:', JSON.stringify(event))
}

// auth.ts ã§ã®ä½¿ç”¨ä¾‹
export const authConfig = {
  callbacks: {
    async signIn({ user, account }) {
      await logAuditEvent({
        userId: user.id,
        action: 'SIGN_IN',
        resource: 'auth',
        ip: req.ip,
        userAgent: req.headers['user-agent'],
        timestamp: new Date(),
      })
      return true
    },
  },
}
```

## å®Ÿè·µçš„ãªèªè¨¼å®Ÿè£…ä¾‹

å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§Auth.jsã‚’ä½¿ç”¨ã™ã‚‹éš›ã®å®Ÿè·µçš„ãªä¾‹ã‚’ã€ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¨Server Actionsã‚’å«ã‚ã¦è§£èª¬ã™ã‚‹ã€‚

### ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ä½œæˆ

Auth.jsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšãƒ¼ã‚¸ã§ã¯ãªãã€ã‚¢ãƒ—ãƒªã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ãŸã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã‚ˆã†ã€‚

#### ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// app/(auth)/signin/page.tsx
import { Suspense } from "react"
import { SignInForm } from "@/components/auth/signin-form"
import { Providers } from "@/components/auth/providers"

export default function SignInPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³
          </h2>
        </div>

        <Suspense fallback={<div>èª­ã¿è¾¼ã¿ä¸­...</div>}>
          {/* OAuth ãƒ—ãƒ­ãƒã‚¤ãƒ€ */}
          <Providers />

          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300" />
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-2 bg-gray-50 text-gray-500">ã¾ãŸã¯</span>
            </div>
          </div>

          {/* Credentials ãƒ•ã‚©ãƒ¼ãƒ  */}
          <SignInForm />
        </Suspense>
      </div>
    </div>
  )
}
```

#### OAuth ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// components/auth/providers.tsx
"use client"

import { signIn } from "next-auth/react"
import { useState } from "react"
import { FaGoogle, FaGithub } from "react-icons/fa"

export function Providers() {
  const [isLoading, setIsLoading] = useState<string | null>(null)

  const handleSignIn = async (provider: string) => {
    setIsLoading(provider)
    try {
      await signIn(provider, {
        callbackUrl: "/dashboard",
        redirect: true
      })
    } catch (error) {
      console.error("Sign in error:", error)
    } finally {
      setIsLoading(null)
    }
  }

  return (
    <div className="space-y-3">
      <button
        onClick={() => handleSignIn("google")}
        disabled={isLoading !== null}
        className="w-full flex justify-center items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
      >
        {isLoading === "google" ? (
          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-900" />
        ) : (
          <>
            <FaGoogle className="w-4 h-4 mr-2 text-red-500" />
            Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
          </>
        )}
      </button>

      <button
        onClick={() => handleSignIn("github")}
        disabled={isLoading !== null}
        className="w-full flex justify-center items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
      >
        {isLoading === "github" ? (
          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-900" />
        ) : (
          <>
            <FaGithub className="w-4 h-4 mr-2" />
            GitHubã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
          </>
        )}
      </button>
    </div>
  )
}
```

#### Credentials ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 

```typescript
// components/auth/signin-form.tsx
"use client"

import { useState } from "react"
import { signIn } from "next-auth/react"
import { useRouter, useSearchParams } from "next/navigation"

export function SignInForm() {
  const [email, setEmail] = useState("")
  const [password, setPassword] = useState("")
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState("")

  const router = useRouter()
  const searchParams = useSearchParams()
  const callbackUrl = searchParams.get("callbackUrl") || "/dashboard"

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsLoading(true)
    setError("")

    try {
      const result = await signIn("credentials", {
        email,
        password,
        redirect: false,
      })

      if (result?.error) {
        setError("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™")
      } else {
        router.push(callbackUrl)
      }
    } catch (error) {
      setError("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ")
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
      {error && (
        <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded">
          {error}
        </div>
      )}

      <div className="space-y-4">
        <div>
          <label htmlFor="email" className="block text-sm font-medium text-gray-700">
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          </label>
          <input
            id="email"
            name="email"
            type="email"
            required
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="your@example.com"
          />
        </div>

        <div>
          <label htmlFor="password" className="block text-sm font-medium text-gray-700">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <input
            id="password"
            name="password"
            type="password"
            required
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      <div>
        <button
          type="submit"
          disabled={isLoading}
          className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
        >
          {isLoading ? (
            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" />
          ) : (
            "ã‚µã‚¤ãƒ³ã‚¤ãƒ³"
          )}
        </button>
      </div>
    </form>
  )
}
```

### Server Actions ã‚’ä½¿ã£ãŸèªè¨¼å‡¦ç†

Next.js 14ã®Server Actionsã‚’æ´»ç”¨ã—ãŸèªè¨¼å‡¦ç†ã®å®Ÿè£…ä¾‹ï¼š

```typescript
// app/(auth)/signin/actions.ts
'use server'

import { signIn } from '@/auth'
import { CredentialsSignin } from 'next-auth'
import { redirect } from 'next/navigation'
import { z } from 'zod'

const signInSchema = z.object({
  email: z.string().email('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'),
  password: z.string().min(6, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'),
})

export async function signInAction(formData: FormData) {
  const rawData = {
    email: formData.get('email') as string,
    password: formData.get('password') as string,
  }

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const result = signInSchema.safeParse(rawData)
  if (!result.success) {
    return {
      error: result.error.errors[0].message,
    }
  }

  try {
    await signIn('credentials', {
      email: result.data.email,
      password: result.data.password,
      redirect: false,
    })
  } catch (error) {
    if (error instanceof CredentialsSignin) {
      return {
        error: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™',
      }
    }
    return {
      error: 'ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ',
    }
  }

  redirect('/dashboard')
}
```

#### Server Action ã‚’ä½¿ç”¨ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ 

```typescript
// components/auth/signin-form-server-action.tsx
import { signInAction } from "@/app/(auth)/signin/actions"

export function SignInFormServerAction() {
  return (
    <form action={signInAction} className="mt-8 space-y-6">
      <div className="space-y-4">
        <div>
          <label htmlFor="email" className="block text-sm font-medium text-gray-700">
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          </label>
          <input
            id="email"
            name="email"
            type="email"
            required
            className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="your@example.com"
          />
        </div>

        <div>
          <label htmlFor="password" className="block text-sm font-medium text-gray-700">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <input
            id="password"
            name="password"
            type="password"
            required
            className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      <div>
        <button
          type="submit"
          className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          ã‚µã‚¤ãƒ³ã‚¤ãƒ³
        </button>
      </div>
    </form>
  )
}
```

### ãƒ­ãƒ¼ãƒ« ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰

```typescript
// lib/auth-utils.ts
import { auth } from "@/auth"
import { redirect } from "next/navigation"

export async function requireAuth() {
  const session = await auth()
  if (!session) {
    redirect("/signin")
  }
  return session
}

export async function requireRole(role: string) {
  const session = await requireAuth()
  if (session.user.role !== role) {
    redirect("/unauthorized")
  }
  return session
}

// ä½¿ç”¨ä¾‹ï¼šç®¡ç†è€…ãƒšãƒ¼ã‚¸
// app/admin/page.tsx
import { requireRole } from "@/lib/auth-utils"

export default async function AdminPage() {
  await requireRole("admin")

  return (
    <div>
      <h1>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h1>
      <p>ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™</p>
    </div>
  )
}
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

```typescript
// app/(auth)/error/page.tsx
import { Suspense } from "react"
import { ErrorDisplay } from "@/components/auth/error-display"

export default function AuthError() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full">
        <Suspense fallback={<div>èª­ã¿è¾¼ã¿ä¸­...</div>}>
          <ErrorDisplay />
        </Suspense>
      </div>
    </div>
  )
}

// components/auth/error-display.tsx
"use client"

import { useSearchParams } from "next/navigation"
import Link from "next/link"

const errorMessages = {
  Configuration: "ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
  AccessDenied: "ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚é©åˆ‡ãªæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
  Verification: "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
  Default: "èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
}

export function ErrorDisplay() {
  const searchParams = useSearchParams()
  const error = searchParams.get("error") as keyof typeof errorMessages

  const message = errorMessages[error] || errorMessages.Default

  return (
    <div className="bg-white p-8 rounded-lg shadow-md">
      <div className="text-center">
        <div className="text-red-500 text-6xl mb-4">âš ï¸</div>
        <h1 className="text-2xl font-bold text-gray-900 mb-4">
          èªè¨¼ã‚¨ãƒ©ãƒ¼
        </h1>
        <p className="text-gray-600 mb-6">{message}</p>
        <Link
          href="/signin"
          className="inline-flex items-center px-4 py-2 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
        >
          ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
        </Link>
      </div>
    </div>
  )
}
```

## ã¾ã¨ã‚ï¼šAuth.js v5ã§æ§‹ç¯‰ã™ã‚‹ç¾ä»£çš„ãªèªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

ã“ã®è¨˜äº‹ã§ã¯ã€Auth.js (NextAuth v5) ã®åŸºæœ¬æ¦‚å¿µã‹ã‚‰å®Ÿè·µçš„ãªå®Ÿè£…ã¾ã§ã€åŒ…æ‹¬çš„ã«è§£èª¬ã—ãŸã€‚

### å­¦ã‚“ã ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆ

#### 1. **Auth.js v5ã®æ”¹å–„ç‚¹**

- è¨­å®šã®ä¸€å…ƒåŒ–ï¼ˆ`auth.ts`ï¼‰
- API ã®çµ±ä¸€ï¼ˆ`auth()` é–¢æ•°ï¼‰
- ç’°å¢ƒå¤‰æ•°ã®çµ±ä¸€ï¼ˆ`AUTH_*` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰
- TypeScript ã‚µãƒãƒ¼ãƒˆã®å¼·åŒ–

#### 2. **ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®é¸æŠ**

- **Database Strategy**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦–ã€å³åº§ã®ç„¡åŠ¹åŒ–å¯èƒ½
- **JWT Strategy**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«

#### 3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**

- é©åˆ‡ãªç’°å¢ƒå¤‰æ•°è¨­å®š
- OAuth ã‚¹ã‚³ãƒ¼ãƒ—ã®æœ€å°åŒ–
- Credentials èªè¨¼ã®å¼·åŒ–ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æœ€é©åŒ–

#### 4. **å®Ÿè·µçš„ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³**

- ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
- Server Actions ã®æ´»ç”¨
- ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### æ¬¡ã«å­¦ã¶ã¹ãã“ã¨

1. **é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½**
   - äºŒè¦ç´ èªè¨¼ï¼ˆ2FAï¼‰ã®å®Ÿè£…
   - WebAuthn/ãƒ‘ã‚¹ã‚­ãƒ¼ã®å°å…¥
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒã®å¯¾ç­–

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æœ€é©åŒ–
   - CDN ã¨ã®é€£æº

3. **ç›£è¦–ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**
   - èªè¨¼ãƒ­ã‚°ã®åˆ†æ
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç›£è¦–
   - å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

4. **ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é€£æº**
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®å…±æœ‰
   - ã‚µãƒ¼ãƒ“ã‚¹é–“èªè¨¼
   - API ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã¨ã®çµ±åˆ

### å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- [ ] `next-auth@beta` ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] `auth.ts` ã®åŸºæœ¬è¨­å®š
- [ ] ç’°å¢ƒå¤‰æ•°ã®é©åˆ‡ãªè¨­å®šï¼ˆ`AUTH_*`ï¼‰
- [ ] API ãƒ«ãƒ¼ãƒˆï¼ˆ`[...nextauth]/route.ts`ï¼‰ã®ä½œæˆ

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- [ ] `AUTH_SECRET` ã®ç”Ÿæˆã¨è¨­å®š
- [ ] OAuth ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®é©åˆ‡ãªè¨­å®š
- [ ] ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒˆä¿è­·
- [ ] CSRF ä¿è­·ã®ç¢ºèª

#### æœ¬ç•ªç’°å¢ƒå¯¾å¿œ

- [ ] `AUTH_TRUST_HOST=true` ã®è¨­å®š
- [ ] HTTPS ã®å¼·åˆ¶
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š
- [ ] ç›£æŸ»ãƒ­ã‚°ã®å®Ÿè£…

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

- [ ] ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ä½œæˆ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤º
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®è€ƒæ…®

### æœ€çµ‚çš„ãªæ¨å¥¨äº‹é …

Auth.js v5 ã¯ã€ç¾ä»£çš„ãªWeb ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦å¼·åŠ›ã§æŸ”è»Ÿãªèªè¨¼ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã™ã‚‹ã€‚ä»¥ä¸‹ã®ç‚¹ã‚’æ„è­˜ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ã‚¢ã§ä½¿ã„ã‚„ã™ã„èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã‚‹ï¼š

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: å¸¸ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æœ€å„ªå…ˆã«è€ƒãˆã‚‹
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®é‡è¦–**: ç›´æ„Ÿçš„ã§ä½¿ã„ã‚„ã™ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›
3. **é©åˆ‡ãªæˆ¦ç•¥é¸æŠ**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ä»¶ã«å¿œã˜ã¦Database/JWTæˆ¦ç•¥ã‚’é¸æŠ
4. **ç¶™ç¶šçš„ãªæ”¹å–„**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‹•å‘ã‚’è¿½è·¡ã—ã€å®šæœŸçš„ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

Auth.js v5 ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€èªè¨¼ã®è¤‡é›‘ã•ã‹ã‚‰è§£æ”¾ã•ã‚Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ã‚¢æ©Ÿèƒ½é–‹ç™ºã«é›†ä¸­ã§ãã‚‹ã€‚ã¾ãšã¯å°ã•ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å§‹ã‚ã¦ã€å¾ã€…ã«é«˜åº¦ãªæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã„ãã“ã¨ã‚’ãŠå‹§ã‚ã™ã‚‹ã€‚
